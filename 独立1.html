<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件管理器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
/* 1. 全局基础 */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background: #030712;
  color: #f3f4f6;
  font-family: 'Inter', 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
  min-height: 100vh;
  box-sizing: border-box;
  overflow-x: hidden;
}

/* 2. 隐藏和显示 */
.hidden { display: none !important; }
.flex { display: flex !important; }
.flex-col { flex-direction: column !important; }
.gap-6 { gap: 1.5rem !important; }
.gap-4 { gap: 1rem !important; }
.gap-3 { gap: 0.75rem !important; }
.gap-2 { gap: 0.5rem !important; }
.gap-1 { gap: 0.25rem !important; }
.justify-center { justify-content: center !important; }
.items-center { align-items: center !important; }
.justify-between { justify-content: space-between !important; }
.justify-around { justify-content: space-around !important; }
.min-h-screen { min-height: 100vh !important; }
.overflow-x-hidden { overflow-x: hidden !important; }
.overflow-y-auto { overflow-y: auto !important; }
.whitespace-nowrap { white-space: nowrap !important; }
.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rounded-xl { border-radius: 0.75rem !important; }
.rounded-lg { border-radius: 0.5rem !important; }
.rounded-full { border-radius: 9999px !important; }
.rounded-8px { border-radius: 8px !important; }
.p-3 { padding: 0.75rem !important; }
.p-4 { padding: 1rem !important; }
.p-5 { padding: 1.25rem !important; }
.p-6 { padding: 1.5rem !important; }
.p-7 { padding: 1.75rem !important; }
.py-1 { padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; }
.py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
.py-5 { padding-top: 1.25rem !important; padding-bottom: 1.25rem !important; }
.px-4 { padding-left: 1rem !important; padding-right: 1rem !important; }
.m-0 { margin: 0 !important; }
.mb-4 { margin-bottom: 1rem !important; }
.mb-10 { margin-bottom: 2.5rem !important; }
.mt-1 { margin-top: 0.25rem !important; }
.mt-2 { margin-top: 0.5rem !important; }
.mt-3 { margin-top: 0.75rem !important; }
.mt-4 { margin-top: 1rem !important; }
.text-center { text-align: center !important; }
.text-xs { font-size: 0.75rem !important; }
.text-sm { font-size: 0.875rem !important; }
.text-3xl { font-size: 1.875rem !important; }
.font-bold { font-weight: bold !important; }
.font-medium { font-weight: 500 !important; }
.bg-black { background: #000 !important; }
.bg-white { background: #fff !important; }
.bg-gray-400 { background: #9ca3af !important; }
.bg-gray-700 { background: #374151 !important; }
.bg-gray-600 { background: #4b5563 !important; }
.bg-gray-300 { background: #d1d5db !important; }
.bg-[#030712] { background: #030712 !important; }
.bg-[#111827] { background: #111827 !important; }
.bg-[#6b7280] { background: #6b7280 !important; }
.bg-[#4b5563] { background: #4b5563 !important; }
.bg-[#222] { background: #222 !important; }
.bg-[#f8d7da] { background: #f8d7da !important; }
.text-white { color: #fff !important; }
.text-gray-400 { color: #9ca3af !important; }
.text-gray-300 { color: #d1d5db !important; }
.text-[#842029] { color: #842029 !important; }
.text-[#3b82f6] { color: #3b82f6 !important; }
.text-green-600 { color: #16a34a !important; }
.text-red-400 { color: #f87171 !important; }
.text-red-500 { color: #ef4444 !important; }
.text-yellow-500 { color: #eab308 !important; }
.text-blue-500 { color: #3b82f6 !important; }
.text-blue-400 { color: #60a5fa !important; }
.text-orange-500 { color: #f97316 !important; }
.text-yellow-600 { color: #ca8a04 !important; }
.text-green-400 { color: #4ade80 !important; }
.text-14px { font-size: 14px !important; }
.w-full { width: 100% !important; }
.max-w-md { max-width: 28rem !important; }
.max-w-5xl { max-width: 64rem !important; }
.max-w-[80%] { max-width: 80% !important; }
.max-h-[80vh] { max-height: 80vh !important; }
.h-full { height: 100% !important; }
.h-screen { height: 100vh !important; }
.h-10 { height: 2.5rem !important; }
.h-10px { height: 10px !important; }
.w-10 { width: 2.5rem !important; }
.w-1\/4 { width: 25% !important; }
.min-h-[70vh] { min-height: 70vh !important; }
.min-h-[60vh] { min-height: 60vh !important; }
.min-h-[120px] { min-height: 120px !important; }
.rounded-4px { border-radius: 4px !important; }
.box-shadow-```math
.*``` { /* 你可以用box-shadow: ...; 具体值按你原设计 */ }
.transition-colors { transition: color 0.2s, background 0.2s; }
.transition-opacity-```math
0\.3s_ease``` { transition: opacity 0.3s ease; }
.transition-```math
opacity_0\.3s_ease,transform_0\.3s_ease``` { transition: opacity 0.3s ease, transform 0.3s ease; }
.bg-```math
rgbaKATEX_INLINE_OPEN17,24,39,0\.8KATEX_INLINE_CLOSE``` { background: rgba(17,24,39,0.8) !important; }
.bg-```math
rgbaKATEX_INLINE_OPEN17,24,39,0\.7KATEX_INLINE_CLOSE``` { background: rgba(17,24,39,0.7) !important; }
.bg-```math
rgbaKATEX_INLINE_OPEN15,81,50,0\.9KATEX_INLINE_CLOSE``` { background: rgba(15,81,50,0.9) !important; }
.backdrop-blur-```math
10px``` { backdrop-filter: blur(10px) !important; }
.shadow-```math
.*``` { /* 你可以用box-shadow: ...; 具体值按你原设计 */ }

/* 登录界面 */
#authScreen {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  padding: 1.5rem;
  justify-content: center;
  gap: 1.5rem;
  background: #030712;
}
#authScreen .text-center {
  margin-bottom: 2.5rem;
}
#authScreen input, #authScreen button {
  width: 100%;
  border-radius: 0.5rem;
  padding: 0.75rem;
  outline: none;
  font-size: 1rem;
}
#authScreen input {
  background: #030712;
  color: #f3f4f6;
  border: none;
  margin-bottom: 1rem;
}
#authScreen button {
  background: #6b7280;
  color: #fff;
  border: none;
  transition: background 0.2s;
  cursor: pointer;
}
#authScreen button:hover {
  background: #4b5563;
}

/* 主界面布局 */
#app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background: #030712;
}

/* 顶部 header */
header {
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 0.5rem 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 10;
}

/* 路径导航 */
#pathNavContainer {
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  padding: 0.25rem 0;
  overflow-x: auto;
  white-space: nowrap;
}
#pathNav {
  display: flex;
  gap: 0.25rem;
  font-size: 0.875rem;
}

/* 仓库列表和文件列表 */
#repoList, #fileList {
  padding: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
#repoList > div, #fileList > div {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: #111827;
  border-radius: 0.75rem;
  padding: 0.75rem;
  transition: background 0.2s;
  cursor: pointer;
}
#repoList > div:hover, #fileList > div:hover {
  background: #222b3a;
}
#fileList .multi-select-checkbox {
  width: 1.1em;
  height: 1.1em;
  margin-right: 0.7em;
  accent-color: #0ea5e9;
  vertical-align: middle;
  cursor: pointer;
}

/* 多选操作栏 */
#multiActionBar {
  width: 100%;
  position: fixed;
  bottom: 4.5em;
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: space-around;
  background: rgba(17,24,39,0.95);
  z-index: 20;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
  padding: 0.5em 0;
}
#multiActionBar button {
  width: 14%;
  height: 2em;
  margin: 0 5px;
  border: 0;
  border-radius: .5rem;
  background: linear-gradient(90deg,#0ea5e9,#6366f1);
  color: #fff;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  cursor: pointer;
}
#multiActionBar button:active {
  background: linear-gradient(90deg,#6366f1,#0ea5e9);
}
#selectedCount {
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  margin: 0 .5em;
  text-align: right;
  margin-right: 15%;
  margin-bottom: 5%;
}

/* 底部操作栏 */
footer {
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
  padding: 1.25rem 1rem;
  display: flex;
  justify-content: space-around;
  position: relative;
  z-index: 10;
}
footer button {
  flex: 1 1 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0.5rem;
  background: none;
  border: none;
  color: #f3f4f6;
  font-size: 1.1em;
  cursor: pointer;
  transition: color 0.2s;
}
footer button:hover {
  color: #0ea5e9;
}

/* Toast提示 */
#toast {
  position: fixed;
  bottom: 5em;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 0.5em 1.5em;
  border-radius: 9999px;
  color: #fff;
  z-index: 30;
  font-size: 1rem;
  display: none;
}
#toast.show {
  display: block;
}

/* 通用模态框 */
#modalOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}
#modalOverlay.flex {
  display: flex;
}
#modalContent {
  background: #111827;
  border-radius: 1rem;
  padding: 2rem;
  max-width: 28rem;
  width: 90vw;
  color: #fff;
}

/* 右键菜单 */
#contextMenu {
  position: fixed;
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 0.75rem;
  z-index: 50;
  width: 12rem;
  display: none;
}
#contextMenu .py-1 {
  padding-top: 0.25rem;
  padding-bottom: 0.25rem;
}
#contextMenuItems a {
  display: block;
  padding: 0.5rem 1rem;
  font-size: 0.95em;
  color: #f3f4f6;
  text-decoration: none;
  border-radius: 0.5rem;
  transition: background 0.2s;
}
#contextMenuItems a:hover {
  background: #222b3a;
}
.text-red-400 { color: #f87171 !important; }

/* 上传面板 */
#uploadPanel {
  position: fixed;
  bottom: 5em;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 1rem;
  padding: 1.5rem;
  width: 90vw;
  max-width: 28rem;
  z-index: 40;
  display: none;
}
#uploadPanel h3 {
  font-weight: 500;
  margin-bottom: 1rem;
}
#uploadItems {
  max-height: 10rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.upload-progress {
  height: 0.375rem;
  background: #4ade80;
  border-radius: 9999px;
  transition: width 0.3s;
}
.upload-status {
  font-size: 0.85em;
  color: #9ca3af;
}
.text-green-400 { color: #4ade80 !important; }
.text-red-400 { color: #f87171 !important; }


/* 编辑文件模态框 */
#editModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1.75rem;
}
#editModal.flex {
  display: flex;
}
#editModal > div {
  background: #111827;
  border-radius: 1rem;
  max-width: 64rem;
  width: 100%;
  min-height: 70vh;
  display: flex;
  flex-direction: column;
}
#editModal .flex {
  display: flex;
}
#editModal .justify-between {
  justify-content: space-between;
}
#editModal .items-center {
  align-items: center;
}
#editModal h5 {
  font-size: 1rem;
  font-weight: bold;
}
#editStatus {
  margin: 0.1rem 0;
  border-radius: 0.375rem;
  min-height: 1.5em;
}
#editorOverlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(17,24,39,0.7);
  z-index: 10;
  border-radius: 0.375rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#editorOverlay.opacity-100 {
  opacity: 1;
  pointer-events: auto;
}
#saveNotification {
  position: absolute;
  top: 2.5rem;
  right: 2.5rem;
  background: rgba(15,81,50,0.9);
  color: #fff;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 14px;
  z-index: 5;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.3s, transform 0.3s;
}
#saveNotification.opacity-100 {
  opacity: 1;
  transform: translateY(0);
}
#fileContent {
  background: #030712;
  width: 100%;
  height: 100%;
  padding: 0.75rem;
  outline: none;
  min-height: 70vh;
  font-size: 0.95em;
  border-top: 1px solid #374151;
  border-bottom: 1px solid #374151;
  color: #f3f4f6;
  resize: vertical;
  border-radius: 0.375rem;
}

/* 媒体预览 */
#mediaPreview {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}
#mediaPreview.flex {
  display: flex;
}
#mediaPreview > div {
  max-width: 80vw;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
#mediaPreview img,
#mediaPreview video {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 0.5rem;
  background: #222b3a;
  display: none;
}
#mediaPreview img.show,
#mediaPreview video.show {
  display: block;
}

/* 音频播放提示（用toast） */
#toastMessage {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* 滚动条美化 */
::-webkit-scrollbar {
  width: 8px;
  background: #222b3a;
}
::-webkit-scrollbar-thumb {
  background: #374151;
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: #4b5563;
}

/* 按钮悬停/激活 */
button:focus, button:active {
  outline: 2px solid #0ea5e9;
  outline-offset: 2px;
}

/* 禁用按钮 */
button:disabled, .cursor-not-allowed {
  opacity: 0.5;
  cursor: not-allowed !important;
}

/* 右键菜单高亮 */
#contextMenuItems a.text-red-400:hover {
  background: #f87171 !important;
  color: #fff !important;
}

/* 其它细节 */
input[type="checkbox"].multi-select-checkbox {
  accent-color: #0ea5e9;
  width: 1.1em;
  height: 1.1em;
  margin-right: 0.7em;
  vertical-align: middle;
  cursor: pointer;
}
input[type="text"], input[type="password"], textarea {
  background: #030712;
  color: #f3f4f6;
  border: 1px solid #374151;
  border-radius: 0.5rem;
  padding: 0.75rem;
  font-size: 1rem;
  outline: none;
  transition: border 0.2s;
}
input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
  border: 1.5px solid #0ea5e9;
}
.repo-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: #111827;
  border-radius: 0.75rem;
  padding: 0.75rem;
  transition: background 0.2s;
  cursor: pointer;
  margin-bottom: 0.5rem;
}
.repo-item:hover {
  background: #222b3a;
}
.repo-icon {
  width: 2.5rem;
  height: 2.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: #222b3a;
  font-size: 1.5rem;
  color: #9ca3af;
}
.repo-info {
  flex: 1 1 0;
  min-width: 0;
}
.repo-title {
  font-weight: 500;
  font-size: 1.1em;
  margin: 0;
  color: #fff;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.repo-meta {
  font-size: 0.85em;
  color: #9ca3af;
  margin: 0.2em 0 0 0;
}
.repo-desc {
  font-size: 0.85em;
  color: #9ca3af;
  margin: 0.2em 0 0 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: #111827;
  border-radius: 0.75rem;
  padding: 0.75rem;
  transition: background 0.2s;
  cursor: pointer;
  margin-bottom: 0.5rem;
}
.file-item:hover {
  background: #222b3a;
}
.file-icon {
  width: 2.5rem;
  height: 2.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: #222b3a;
  font-size: 1.5rem;
}
.file-info {
  flex: 1 1 0;
  min-width: 0;
}
.file-title {
  font-weight: 500;
  font-size: 1.1em;
  margin: 0;
  color: #fff;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.file-meta {
  font-size: 0.85em;
  color: #9ca3af;
  margin: 0.2em 0 0 0;
}
.multi-select-checkbox {
  width: 1.1em;
  height: 1.1em;
  margin-right: 0.7em;
  accent-color: #0ea5e9;
  vertical-align: middle;
  cursor: pointer;
}
.multi-action-bar {
  width: 100%;
  position: fixed;
  bottom: 4.5em;
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: space-around;
  background: rgba(17,24,39,0.95);
  z-index: 20;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
  padding: 0.5em 0;
}
.multi-action-bar button {
  width: 14%;
  height: 2em;
  margin: 0 5px;
  border: 0;
  border-radius: .5rem;
  background: linear-gradient(90deg,#0ea5e9,#6366f1);
  color: #fff;
  font-size: 1.1em;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  cursor: pointer;
}
.multi-action-bar button:active {
  background: linear-gradient(90deg,#6366f1,#0ea5e9);
}
#selectedCount {
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  margin: 0 .5em;
  text-align: right;
  margin-right: 15%;
  margin-bottom: 5%;
}
#editModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1.75rem;
}
#editModal.flex { display: flex; }
.edit-modal-inner {
  background: #111827;
  border-radius: 1rem;
  max-width: 64rem;
  width: 100%;
  min-height: 70vh;
  display: flex;
  flex-direction: column;
}
.edit-header, .edit-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
}
.edit-content {
  flex: 1 1 0;
  position: relative;
  padding: 1rem;
}
#editorOverlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(17,24,39,0.7);
  z-index: 10;
  border-radius: 0.375rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#editorOverlay.opacity-100 {
  opacity: 1;
  pointer-events: auto;
}
#saveNotification {
  position: absolute;
  top: 2.5rem;
  right: 2.5rem;
  background: rgba(15,81,50,0.9);
  color: #fff;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 14px;
  z-index: 5;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.3s, transform 0.3s;
}
#saveNotification.opacity-100 {
  opacity: 1;
  transform: translateY(0);
}
#fileContent {
  background: #030712;
  width: 100%;
  height: 100%;
  padding: 0.75rem;
  outline: none;
  min-height: 70vh;
  font-size: 0.95em;
  border-top: 1px solid #374151;
  border-bottom: 1px solid #374151;
  color: #f3f4f6;
  resize: vertical;
  border-radius: 0.375rem;
}

#contextMenu {
  position: fixed;
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 0.75rem;
  z-index: 50;
  width: 12rem;
  display: none;
}
#contextMenuItems a {
  display: block;
  padding: 0.5rem 1rem;
  font-size: 0.95em;
  color: #f3f4f6;
  text-decoration: none;
  border-radius: 0.5rem;
  transition: background 0.2s;
}
#contextMenuItems a:hover {
  background: #222b3a;
}
#toast {
  position: fixed;
  bottom: 5em;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  padding: 0.5em 1.5em;
  border-radius: 9999px;
  color: #fff;
  z-index: 30;
  font-size: 1rem;
  display: none;
}
#toast.show { display: block; }
#uploadPanel {
  position: fixed;
  bottom: 5em;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 1rem;
  padding: 1.5rem;
  width: 90vw;
  max-width: 28rem;
  z-index: 40;
  display: none;
}
#uploadPanel h3 {
  font-weight: 500;
  margin-bottom: 1rem;
}
#uploadItems {
  max-height: 10rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.upload-progress {
  height: 0.375rem;
  background: #4ade80;
  border-radius: 9999px;
  transition: width 0.3s;
}
.upload-status {
  font-size: 0.85em;
  color: #9ca3af;
}
#mediaPreview {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}
#mediaPreview.flex { display: flex; }
#mediaPreview > div {
  max-width: 80vw;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
#mediaPreview img,
#mediaPreview video {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 0.5rem;
  background: #222b3a;
  display: none;
}
#mediaPreview img.show,
#mediaPreview video.show {
  display: block;
}

#fileList.dragover { background: #1e293b; border: 2px dashed #0ea5e9; }

#globalLoading {
  position: fixed; inset: 0; background: rgba(0,0,0,0.3);
  display: none; align-items: center; justify-content: center; z-index: 1000;
}
.loading-spinner {
  width: 48px; height: 48px; border: 4px solid #0ea5e9; border-top: 4px solid transparent;
  border-radius: 50%; animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }


#uploadPanel {
  position: fixed;
  bottom: 5em;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(17,24,39,0.8);
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-radius: 1rem;
  padding: 1.5rem;
  width: 90vw;
  max-width: 28rem;
  z-index: 40;
  display: none;
}
#uploadPanel h3 {
  font-weight: 500;
  margin-bottom: 1rem;
}
#uploadItems {
  max-height: 10rem;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.upload-item { display: flex; flex-direction: column; gap: 0.5em; }
.upload-item-header { display: flex; justify-content: space-between; font-size: 1em; }
.upload-item-name { flex: 1 1 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.upload-item-size { color: #9ca3af; font-size: 0.95em; }
.upload-progress-bar { height: 0.375rem; background: #374151; border-radius: 9999px; overflow: hidden; }
.upload-progress { height: 100%; background: #4ade80; width: 0; transition: width 0.3s; }
.upload-status { font-size: 0.85em; color: #9ca3af; }
.upload-success { color: #4ade80 !important; }
.upload-fail { color: #f87171 !important; }
    </style>
</head>
<body class="bg-[#030712] text-[#f3f4f6] min-h-screen overflow-x-hidden">
    <!-- 登录界面 -->
    <!-- 登录界面 -->
<div id="authScreen">
  <div class="login-logo">
    <i class="fa fa-github"></i>
    <h1>GitHub文件管理器</h1>
  </div>
  <div class="login-panel">
    <input type="text" id="tokenInput" placeholder="输入GitHub访问令牌">
    <button id="authBtn">登录</button>
  </div>
</div>

<!-- 主应用界面 -->
<div id="app" class="hidden">
  <!-- 顶部导航栏 -->
  <header>
    <div class="header-left">
      <i class="fa fa-github"></i>
      <h1 id="currentRepo">选择仓库</h1>
    </div>
    <div class="header-right">
      <button id="mainMenuBtn" title="菜单">
        <i class="fa fa-github"></i>
      </button>
    </div>
  </header>

  <!-- 路径导航 -->
  <div id="pathNavContainer" class="hidden">
    <div id="pathNav"></div>
  </div>

  <!-- 主内容区 -->
  <main>
    <!-- 仓库列表 -->
    <div id="repoList">
      <!-- 仓库项由JS动态插入 -->
    </div>
    <!-- 文件列表 -->
    <div id="fileList" class="hidden">
      <!-- 文件项由JS动态插入 -->
    </div>
  </main>

  <!-- 底部操作栏 -->
  <footer>
    <button id="backBtn" title="返回上级"><i class="fa fa-arrow-up"></i></button>
    <button id="newFolderBtn" onclick="createFolder()" title="新建文件夹"><i class="fa fa-folder"></i></button>
    <button id="newFileBtn" onclick="createFile()" title="新建文件"><i class="fa fa-file-o"></i></button>
    <button id="uploadBtn" title="上传文件"><i class="fa fa-upload"></i></button>
  </footer>




<!-- 多选操作栏（批量操作按钮区） -->
<div id="multiActionBar" class="hidden">
  <p id="selectedCount"></p>
  <button id="batchDeleteBtn" title="批量删除"><i class="fa fa-trash"></i></button>
  <button id="batchZipBtn" title="打包下载"><i class="fa fa-file-zip-o"></i></button>
  <button id="invertSelectBtn" title="反选"><i class="fa fa-random"></i></button>
  <button id="selectAllBtn" title="全选"><i class="fa fa-check-square-o"></i></button>
</div>

<!-- 编辑文件模态框 -->
<div id="editModal" class="hidden">
  <div>
    <div class="edit-header">
      <h5 id="editFileName">编辑文件</h5>
      <button id="closeEditModal"><i class="fa fa-times"></i></button>
    </div>
    <div id="editStatus"></div>
    <div class="edit-content">
      <div id="editorOverlay"><div><i class="fa fa-spinner fa-spin"></i></div></div>
      <div id="saveNotification"><i class="fa fa-check"></i> 保存成功</div>
      <textarea id="fileContent"></textarea>
    </div>
    <div class="edit-footer">
      <button id="cancelEdit">取消</button>
      <button id="saveEdit">保存修改</button>
    </div>
  </div>
</div>

<!-- 文件上传面板 -->
<div id="uploadPanel" class="hidden">
  <h3>文件上传中</h3>
  <div id="uploadItems"></div>
</div>

<!-- 通用模态框 -->
<div id="modalOverlay" class="hidden">
  <div id="modalContent"></div>
</div>

<!-- 右键菜单 -->
<div id="contextMenu" class="hidden">
  <div id="contextMenuItems"></div>
</div>

<!-- Toast提示 -->
<div id="toast" class="hidden">
  <span id="toastMessage"></span>
</div>

<!-- 隐藏的文件上传input -->
<input type="file" id="fileUploadInput" multiple class="hidden">

<!-- 主菜单弹窗 -->
<div id="mainMenuPopup" class="hidden">
  <button id="menuLogout"><i class="fa fa-sign-out"></i> 退出登录</button>
  <button id="menuRepoList"><i class="fa fa-list"></i> 仓库列表</button>
  <button id="menuRefresh"><i class="fa fa-refresh"></i> 刷新页面</button>
</div>

<!-- 媒体预览（图片/视频） -->
<div id="mediaPreview" class="hidden">
  <div>
    <img src="" class="hidden">
    <video controls class="hidden"></video>
  </div>
</div>


<div id="multiActionBar" class="multi-action-bar hidden">
  <p id="selectedCount"></p>
  <button id="batchDeleteBtn"><i class="fa fa-trash"></i></button>
  <button id="batchZipBtn"><i class="fa fa-file-zip-o"></i></button>
  <button id="invertSelectBtn"><i class="fa fa-random"></i></button>
  <button id="selectAllBtn"><i class="fa fa-check-square-o"></i></button>
</div>

<div id="editModal" class="hidden">
  <div class="edit-modal-inner">
    <div class="edit-header">
      <h5 id="editFileName">编辑文件</h5>
      <button id="closeEditModal"><i class="fa fa-times"></i></button>
    </div>
    <div id="editStatus"></div>
    <div class="edit-content">
      <div id="editorOverlay"><div><i class="fa fa-spinner fa-spin"></i></div></div>
      <div id="saveNotification"><i class="fa fa-check"></i> 保存成功</div>
      <textarea id="fileContent"></textarea>
    </div>
    <div class="edit-footer">
      <button id="cancelEdit">取消</button>
      <button id="saveEdit">保存修改</button>
    </div>
  </div>
</div>

<div id="contextMenu" class="hidden">
  <div id="contextMenuItems"></div>
</div>
<div id="toast" class="hidden">
  <span id="toastMessage"></span>
</div>
<div id="uploadPanel" class="hidden">
  <h3>文件上传中</h3>
  <div id="uploadItems"></div>
</div>
<div id="mediaPreview" class="hidden">
  <div>
    <img src="" class="hidden">
    <video controls class="hidden"></video>
  </div>
</div>
<div id="uploadPanel" class="hidden">
  <h3>文件上传中</h3>
  <div id="uploadItems"></div>
</div>








<script>
// 状态管理
const state = {
  token: localStorage.getItem('gh_token') || null,
  currentRepo: null,
  currentPath: '',
  files: [],
  repos: [],
  selectedFile: null,
  selectedRepo: null,
  uploadQueue: [],
  editingFile: null,
  fileSha: '',
  originalContent: '',
  proxyUrl: 'https://gh-proxy.com/',
  navHistory: ['root']
};

const el = Object.fromEntries(
  [
    'authScreen', 'app', 'tokenInput', 'authBtn', 'fileList', 'repoList',
    'pathNav', 'pathNavContainer', 'currentRepo', 'logoutBtn', 'newFolderBtn',
    'uploadBtn', 'refreshBtn', 'repoBtn', 'backBtn', 'modalOverlay', 'modalContent',
    'contextMenu', 'contextMenuItems', 'toast', 'toastMessage', 'uploadPanel',
    'uploadItems', 'editModal', 'editFileName', 'fileContent', 'closeEditModal',
    'cancelEdit', 'saveEdit', 'editStatus', 'editorOverlay', 'saveNotification',
    'fileUploadInput'
  ].map(id => [id, document.getElementById(id)])
);

// 工具函数
function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    js: 'fa-code text-yellow-500',
    html: 'fa-html5 text-orange-500',
    css: 'fa-css3 text-blue-500',
    json: 'fa-file-code-o text-gray-400',
    md: 'fa-file-text-o text-blue-400',
    png: 'fa-file-image-o text-green-400',
    jpg: 'fa-file-image-o text-green-400',
    jpeg: 'fa-file-image-o text-green-400',
    gif: 'fa-file-image-o text-green-400',
    pdf: 'fa-file-pdf-o text-red-500',
    zip: 'fa-file-zip-o text-yellow-600',
    git: 'fa-git text-red-600'
  };
  return icons[ext] || 'fa-file-o text-gray-400';
}
function formatSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
function formatRelativeTime(date) {
  const diffMs = new Date() - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);
  if (diffMins < 1) return '刚刚';
  if (diffMins < 60) return `${diffMins}分钟前`;
  if (diffHours < 24) return `${diffHours}小时前`;
  if (diffDays < 30) return `${diffDays}天前`;
  return date.toLocaleDateString();
}
function escapeHtml(unsafe) {
  return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;")
    .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

// 视图控制
function toggleView(showRepoList) {
  if (showRepoList) {
    el.repoList.classList.remove('hidden');
    el.fileList.classList.add('hidden');
    el.pathNavContainer.classList.add('hidden');
    el.currentRepo.textContent = '选择仓库';
  } else {
    el.repoList.classList.add('hidden');
    el.fileList.classList.remove('hidden');
    el.pathNavContainer.classList.remove('hidden');
  }
}
const showAuth = () => (el.authScreen.classList.remove('hidden'), el.app.classList.add('hidden'));
const showApp = () => (el.authScreen.classList.add('hidden'), el.app.classList.remove('hidden'));
const showModal = content => (el.modalContent.innerHTML = content, el.modalOverlay.classList.remove('hidden'), el.modalOverlay.classList.add('flex'));
const hideModal = () => (el.modalOverlay.classList.add('hidden'), el.modalOverlay.classList.remove('flex'));
const showToast = message => {
  el.toastMessage.textContent = message;
  el.toast.classList.add('show');
  setTimeout(() => el.toast.classList.remove('show'), 3000);
};
function showSaveNotification() {
  el.saveNotification.classList.add('opacity-100', 'translate-y-0');
  setTimeout(() => el.saveNotification.classList.remove('opacity-100', 'translate-y-0'), 3000);
}

// 仓库管理
async function fetchRepos() {
  try {
    state.repos = [];
    el.repoList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-700"></div></div>';
    const res = await fetch('https://api.github.com/user/repos?timestamp=' + Date.now(), {
      headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
    });
    if (!res.ok) throw new Error('获取仓库失败');
    state.repos = await res.json();
    renderRepoList();
    showRepoListView();
  } catch (err) {
    showToast('加载仓库失败');
    console.error(err);
  }
}
function renderRepoList() {
  el.repoList.innerHTML = state.repos.length === 0
    ? '<div class="text-center py-10 text-gray-400"><i class="fa fa-github text-4xl mb-2"></i><p>没有找到仓库</p></div>'
    : '';
  state.repos.forEach(repo => {
    const item = document.createElement('div');
    item.className = 'repo-item';
    item.innerHTML = `
      <div class="repo-icon"><i class="fa fa-github"></i></div>
      <div class="repo-info">
        <p class="repo-title">${repo.name}</p>
        <p class="repo-meta">${repo.private ? '私有仓库' : '公开仓库'} · ${repo.size ? formatSize(repo.size * 1024) : ''} · ${formatRelativeTime(new Date(repo.updated_at))}</p>
        <p class="repo-desc">${repo.description || ''}</p>
      </div>
    `;
    item.addEventListener('click', () => {
      state.currentRepo = repo.full_name;
      state.currentPath = '';
      el.currentRepo.textContent = repo.name;
      renderPathNav();
      fetchFiles();
      toggleView(false);
    });
    el.repoList.appendChild(item);
  });
}
function showRepoListView() {
  el.repoList.classList.remove('hidden');
  el.fileList.classList.add('hidden');
  el.pathNavContainer.classList.add('hidden');
  el.currentRepo.textContent = '选择仓库';
  state.currentRepo = null;
  state.currentPath = '';
}

// 文件管理
async function fetchFiles() {
  if (!state.currentRepo) return;
  el.fileList.innerHTML = `<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>`;
  try {
    const timestamp = Date.now();
    const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${timestamp}`, {
      headers: { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' },
      cache: 'no-store'
    });
    if (!res.ok) {
      if (res.status === 404) { state.files = []; renderFileList(); return; }
      throw new Error('加载文件失败');
    }
    const data = await res.json();
    if (data.message) throw new Error(data.message);
    state.files = Array.isArray(data) ? data : [];
    state.files.sort((a, b) =>
      a.type === 'dir' && b.type !== 'dir' ? -1 :
      a.type !== 'dir' && b.type === 'dir' ? 1 :
      a.name.localeCompare(b.name)
    );
    renderFileList();
  } catch (err) {
    showToast('加载文件失败: ' + err.message);
    console.error(err);
  }
}
function renderFileList() {
  el.fileList.innerHTML = state.files.length === 0
    ? '<div class="text-center py-10 text-gray-400"><i class="fa fa-github text-4xl mb-2"></i><p>仓库为空</p></div>'
    : '';
  state.files.forEach((file, idx) => {
    const isDir = file.type === 'dir';
    const icon = isDir ? 'fa-folder text-yellow-500' : getFileIcon(file.name);
    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      ${!isDir ? `<input type="checkbox" class="multi-select-checkbox" data-index="${idx}">` : ''}
      <div class="file-icon"><i class="fa ${icon}"></i></div>
      <div class="file-info">
        <p class="file-title">${file.name}</p>
        <p class="file-meta">${isDir ? '文件夹' : formatSize(file.size)} · ${file.last_modified ? formatRelativeTime(new Date(file.last_modified)) : '加载中'}</p>
      </div>
    `;
    item.addEventListener('click', (e) => {
      if (e.target.classList.contains('multi-select-checkbox')) return;
      isDir ? navigateToDir(file.name) : editFile(file);
    });
    el.fileList.appendChild(item);
  });
  // 多选checkbox事件
  document.querySelectorAll('.multi-select-checkbox').forEach(cb => {
    cb.onclick = function(e) {
      e.stopPropagation();
      const idx = Number(cb.dataset.index);
      if (cb.checked) {
        if (!window._multiSelect.selected.includes(idx)) window._multiSelect.selected.push(idx);
      } else {
        window._multiSelect.selected = window._multiSelect.selected.filter(i => i !== idx);
      }
      updateMultiBar();
    };
    cb.checked = window._multiSelect.selected.includes(Number(cb.dataset.index));
  });
  updateMultiBar();
}

// 路径导航
function renderPathNav() {
  el.pathNav.innerHTML = '';
  const parts = state.currentPath.split('/').filter(p => p);
  let currentPath = '';
  addPathItem('/', '');
  parts.forEach((part) => {
    currentPath += part + '/';
    addPathItem(part, currentPath);
  });
}
function addPathItem(name, path) {
  const item = document.createElement('span');
  item.className = 'cursor-pointer hover:text-gray-300';
  item.textContent = name;
  item.dataset.path = path;
  item.addEventListener('click', () => {
    el.fileList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
    navigateToPath(path);
  });
  el.pathNav.appendChild(item);
  if (name !== '/') el.pathNav.appendChild(document.createTextNode(' / '));
}
function navigateToDir(dirName) {
  const newPath = state.currentPath ? `${state.currentPath}${dirName}/` : `${dirName}/`;
  state.navHistory.push(newPath);
  state.currentPath = newPath;
  renderPathNav();
  fetchFiles();
}
function navigateToPath(path) {
  state.navHistory.push(path);
  state.currentPath = path;
  renderPathNav();
  fetchFiles();
}

// 多选操作栏
window._multiSelect = { mode: false, selected: [] };
function updateMultiBar() {
  const count = window._multiSelect.selected.length;
  const bar = document.getElementById('multiActionBar');
  if (!window._multiSelect.mode) {
    bar.classList.add('hidden');
    document.querySelectorAll('.multi-select-checkbox').forEach(cb => cb.checked = false);
    return;
  }
  bar.classList.remove('hidden');
  document.getElementById('selectedCount').textContent = count ? `已选择：${count}` : '';
  document.querySelectorAll('.multi-select-checkbox').forEach((cb, idx) => {
    cb.checked = window._multiSelect.selected.includes(Number(cb.dataset.index));
  });
}

// 多选按钮事件
document.getElementById('selectAllBtn').onclick = function() {
  if (!window._multiSelect.mode) return;
  const items = document.querySelectorAll('#fileList > div');
  const fileIndexes = Array.from(items)
    .map((_, i) => i)
    .filter(i => state.files[i].type === 'file');
  if (window._multiSelect.selected.length === fileIndexes.length &&
    fileIndexes.every(i => window._multiSelect.selected.includes(i))) {
    window._multiSelect.selected = [];
  } else {
    window._multiSelect.selected = fileIndexes;
  }
  renderFileList();
};
document.getElementById('invertSelectBtn').onclick = function() {
  if (!window._multiSelect.mode) return;
  const items = document.querySelectorAll('#fileList > div');
  const fileIndexes = Array.from(items)
    .map((_, i) => i)
    .filter(i => state.files[i].type === 'file');
  window._multiSelect.selected = fileIndexes.filter(i => !window._multiSelect.selected.includes(i));
  renderFileList();
};
document.getElementById('batchDeleteBtn').onclick = async function() {
  if (!window._multiSelect.mode || !window._multiSelect.selected.length) return;
  const filesToDelete = window._multiSelect.selected
    .map(idx => state.files[idx])
    .filter(f => f.type === 'file');
  if (!filesToDelete.length) {
    showToast('没有可删除的文件');
    return;
  }
  showModal(`
    <h3 class="font-bold mb-4">批量删除</h3>
    <p class="mb-4 text-gray-300">确定要删除这 <b>${filesToDelete.length}</b> 个文件吗？此操作不可撤销。</p>
    <div class="flex gap-3">
      <button id="cancelBatchDelete" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
      <button id="confirmBatchDelete" class="flex-1 p-3 bg-red-600 hover:bg-red-500 text-white rounded">确认删除</button>
    </div>
  `);
  document.getElementById('cancelBatchDelete').onclick = hideModal;
  document.getElementById('confirmBatchDelete').onclick = async function() {
    this.disabled = true;
    for (const file of filesToDelete) {
      await deleteItem(file);
    }
    window._multiSelect.mode = false;
    window._multiSelect.selected = [];
    renderFileList();
    fetchFiles();
    hideModal();
  };
};
document.getElementById('batchZipBtn').onclick = async function() {
  const btn = this;
  if (window._zipTask && typeof window._zipTask.cancel === 'function') {
    window._zipTask.cancel();
    window._zipTask = null;
    btn.innerHTML = '<i class="fa fa-file-zip-o"></i>';
    showToast('已取消打包');
    return;
  }
  if (!window._multiSelect.mode || !window._multiSelect.selected.length) return;
  const zip = new JSZip();
  const files = window._multiSelect.selected.map(idx => state.files[idx]).filter(f => f.type === 'file');
  if (!files.length) {
    showToast('没有可打包的文件');
    return;
  }
  btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
  for (const file of files) {
    try {
      const url = file.download_url || file.html_url.replace('github.com','raw.githubusercontent.com').replace('/blob/','/');
      const resp = await fetch(url, {cache: 'no-store'});
      const blob = await resp.blob();
      zip.file(file.name, blob);
    } catch (e) {}
  }
  const NativePromise = window.Promise;
  window.Promise = JSZip.external.Promise;
  window._zipTask = zip.generateAsync({type:"blob"});
  window._zipTask.then(function(content) {
    window.Promise = NativePromise;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = `files_${Date.now()}.zip`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }, 500);
    btn.innerHTML = '<i class="fa fa-file-zip-o"></i>';
    window._zipTask = null;
  }).catch(function(e) {
    window.Promise = NativePromise;
    btn.innerHTML = '<i class="fa fa-file-zip-o"></i>';
    window._zipTask = null;
    showToast('打包已取消');
  });
};

// 多选模式切换
document.getElementById('multiSelectBtn')?.addEventListener('click', function() {
  if (!state.currentRepo) {
    showToast('请先进入仓库');
    return;
  }
  window._multiSelect.mode = !window._multiSelect.mode;
  if (!window._multiSelect.mode) window._multiSelect.selected = [];
  renderFileList();
});

// 其它事件监听、编辑、上传、右键菜单等可按你原有逻辑继续补充...

// 初始化
function init() {
  state.token ? (showApp(), fetchRepos()) : showAuth();
  // 绑定其它事件...
}
document.addEventListener('DOMContentLoaded', init);
</script>


<script>
// 显示编辑器弹窗
function showEditModal() {
  el.editModal.classList.remove('hidden');
  el.editModal.classList.add('flex');
  el.editorOverlay.classList.add('opacity-100', 'pointer-events-auto');
  setTimeout(() => el.fileContent.focus(), 10);
  document.getElementById('closeEditModal').onclick = hideEditModal;
  document.getElementById('cancelEdit').onclick = hideEditModal;
}
function hideEditModal() {
  el.editModal.classList.add('hidden');
  el.editModal.classList.remove('flex');
  state.editingFile = state.fileSha = state.originalContent = '';
  el.saveEdit.className = 'flex-1';
}
function showEditStatus(text, type) {
  el.editStatus.textContent = text;
  el.editStatus.className = `m-[0.1rem_0] rounded-[0.375rem] ${type}`;
}
async function editFile(file) {
  state.editingFile = file;
  el.editFileName.textContent = `${file.name}`;
  el.fileContent.value = '';
  showEditStatus('', '');
  showEditModal();
  try {
    const [owner, repo] = state.currentRepo.split('/');
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
      headers: { 'Authorization': `token ${state.token}`, 'User-Agent': 'Mozilla/5.0' }
    });
    if (!res.ok) {
      const err = await res.json();
      el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
      showEditStatus(`加载失败：${err.message}`, 'bg-[#f8d7da] text-[#842029]');
      return;
    }
    const data = await res.json();
    const content = decodeURIComponent(escape(atob(data.content)));
    el.fileContent.value = content;
    state.originalContent = content;
    state.fileSha = data.sha;
    el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
    el.fileContent.addEventListener('input', checkContentChanges);
  } catch (e) {
    el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
    showEditStatus(`错误：${e.message}`, 'bg-[#f8d7da] text-[#842029]');
    console.error(e);
  }
}
function checkContentChanges() {
  const isModified = el.fileContent.value !== state.originalContent;
  el.saveEdit.className = `flex-1 ${isModified ? 'text-[#3b82f6] hover:text-green-600' : 'text-[#6b7280] hover:text-[#4b5563]'}`;
}
async function saveEditedFile() {
  if (!state.editingFile || !state.fileSha) return;
  const currentContent = el.fileContent.value;
  if (currentContent === state.originalContent) {
    showToast('未检测到修改');
    return;
  }
  el.editorOverlay.classList.add('opacity-100', 'pointer-events-auto');
  try {
    const [owner, repo] = state.currentRepo.split('/');
    const encodedContent = btoa(unescape(encodeURIComponent(currentContent)));
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${state.editingFile.path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${state.token}`,
        'Content-Type': 'application/json',
        'User-Agent': 'Mozilla/5.0'
      },
      body: JSON.stringify({
        message: `Update ${state.editingFile.name} via web editor`,
        content: encodedContent,
        sha: state.fileSha
      })
    });
    if (!res.ok) {
      const err = await res.json();
      el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
      showEditStatus(`保存失败：${err.message}`, 'bg-[#f8d7da] text-[#842029]');
      return;
    }
    const result = await res.json();
    state.fileSha = result.content.sha;
    state.originalContent = currentContent;
    el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
    showToast('文件已保存');
    showSaveNotification();
    fetchFiles();
    el.saveEdit.className = 'flex-1';
  } catch (e) {
    el.editorOverlay.classList.remove('opacity-100', 'pointer-events-auto');
    showEditStatus(`错误：${e.message}`, 'bg-[#f8d7da] text-[#842029]');
    console.error(e);
  }
}
</script>

<script>
async function deleteItem(item) {
  const isDir = item.type === 'dir';
  const safeName = escapeHtml(item.name);
  const confirmMessage = isDir
    ? `确定要删除文件夹"${safeName}"吗？这将删除该文件夹及其所有内容。`
    : `确定要删除文件"${safeName}"吗？此操作不可撤销。`;

  showModal(`
    <h3 class="font-bold mb-4">确认删除</h3>
    <p class="mb-4 text-gray-300">${confirmMessage}</p>
    <div class="flex gap-3">
      <button id="cancelDelete" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
      <button id="confirmDelete" class="flex-1 p-3 bg-red-600 hover:bg-red-500 text-white rounded">确认删除</button>
    </div>
  `);

  document.getElementById('cancelDelete').onclick = hideModal;
  document.getElementById('confirmDelete').onclick = async function() {
    this.disabled = true;
    try {
      const [owner, repo] = state.currentRepo.split('/');
      if (isDir) {
        // 递归删除所有文件
        const allFiles = await getAllFiles(item.path);
        for (const f of allFiles) {
          await deleteFileApi(f.path, f.sha, f.name);
        }
        showToast(`文件夹"${safeName}"已删除`);
      } else {
        await deleteFileApi(item.path, item.sha, item.name);
        showToast(`文件"${safeName}"已删除`);
      }
      hideModal();
      fetchFiles();
    } catch (error) {
      showToast(`删除失败: ${error.message}`);
      this.disabled = false;
    }
  };
}
async function deleteFileApi(path, sha, name) {
  const [owner, repo] = state.currentRepo.split('/');
  const res = await fetch(
    `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
    {
      method: 'DELETE',
      headers: {
        Authorization: `token ${state.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Delete ${name}`,
        sha: sha
      })
    }
  );
  if (!res.ok) {
    const errorData = await res.json();
    throw new Error(errorData.message || `删除失败 (HTTP ${res.status})`);
  }
}
async function getAllFiles(path) {
  const [owner, repo] = state.currentRepo.split('/');
  let allFiles = [];
  const res = await fetch(
    `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
    { headers: { Authorization: `token ${state.token}` } }
  );
  if (!res.ok) return [];
  const items = await res.json();
  for (const i of items) {
    if (i.type === 'dir') {
      const subFiles = await getAllFiles(i.path);
      allFiles = [...allFiles, ...subFiles];
    } else {
      allFiles.push(i);
    }
  }
  return allFiles;
}

async function renameItem(item) {
  const isDir = item.type === 'dir';
  showModal(`
    <h3 class="font-bold mb-4">重命名${isDir ? '文件夹' : '文件'}: ${item.name}</h3>
    <input id="newName" value="${item.name}" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4">
    <div class="flex gap-3">
      <button id="cancelRename" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
      <button id="confirmRename" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>确认</button>
    </div>
  `);
  const i = document.getElementById('newName');
  const b = document.getElementById('confirmRename');
  i.oninput = () => {
    const v = i.value.trim(), ok = v && v !== item.name;
    b.disabled = !ok;
    b.className = ok ? 'flex-1 p-3 bg-green-600 hover:bg-green-500 text-white rounded' : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
  };
  b.onclick = async () => {
    const v = i.value.trim();
    if (!v || v === item.name) return;
    b.disabled = true; b.innerHTML = `保存中<i class="fa fa-spinner fa-spin ml-2"></i>`;
    try {
      const [owner, repo] = state.currentRepo.split('/');
      const oldPath = item.path, base = oldPath.slice(0, -item.name.length), newPath = base + v;
      if (isDir) {
        // 递归重命名所有文件
        const files = await getAllFiles(oldPath);
        for (const f of files) {
          const to = f.path.replace(oldPath, newPath);
          const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {headers: {Authorization: `token ${state.token}`}})).json();
          await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${to}`, {method: 'PUT', headers: {Authorization: `token ${state.token}`,'Content-Type': 'application/json'}, body: JSON.stringify({message: `Move ${f.name}`, content: d.content || '', sha: d.sha})});
          await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {method: 'DELETE', headers: {Authorization: `token ${state.token}`,'Content-Type': 'application/json'}, body: JSON.stringify({message: `Delete ${f.name}`, sha: d.sha})});
        }
      } else {
        const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {headers: {Authorization: `token ${state.token}`}})).json();
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${newPath}`, {method: 'PUT', headers: {Authorization: `token ${state.token}`,'Content-Type': 'application/json'}, body: JSON.stringify({message: `Rename to ${v}`, content: d.content, sha: d.sha})});
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {method: 'DELETE', headers: {Authorization: `token ${state.token}`,'Content-Type': 'application/json'}, body: JSON.stringify({message: `Delete old file`, sha: d.sha})});
      }
      showToast(`重命名成功: ${v}`); hideModal(); fetchFiles();
    } catch (e) {
      showToast(`失败: ${e.message}`); b.disabled = false; b.innerHTML = '确认';
    }
  };
  document.getElementById('cancelRename').onclick = hideModal;
}

function initAudioPlayer() {
  let audio = null, currentFile = null;
  const audioExts = ['mp3', 'wav', 'ogg', 'flac', 'm4a'];
  function getAudio() { return audio || (audio = new Audio()); }
  function showPlayStatus(message) {
    showToast(message);
  }
  document.getElementById('fileList').addEventListener('click', (e) => {
    const fileItem = e.target.closest('.file-item');
    if (!fileItem) return;
    const name = fileItem.querySelector('.file-title').textContent;
    const file = state.files.find(f => f.name === name);
    if (!file) return;
    const ext = file.name.split('.').pop()?.toLowerCase();
    if (!audioExts.includes(ext)) return;
    e.stopImmediatePropagation();
    const audio = getAudio();
    const isSameFile = currentFile?.path === file.path;
    if (isSameFile) {
      if (audio.paused) {
        audio.play();
        showPlayStatus(`正在播放: ${file.name}`);
      } else {
        audio.pause();
        showPlayStatus(`已暂停: ${file.name}`);
      }
    } else {
      currentFile = file;
      const rawUrl = file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
      audio.src = `https://gh-proxy.com/${rawUrl}`;
      audio.play();
      showPlayStatus(`正在播放: ${file.name}`);
    }
  }, true);
}
document.addEventListener('DOMContentLoaded', initAudioPlayer);

function escapeHtml(unsafe) {
  return unsafe.replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function init() {
  state.token ? (showApp(), fetchRepos()) : showAuth();
  // 绑定其它事件...
}
document.addEventListener('DOMContentLoaded', init);

</script>

<script>
function copyLink(file) {
  const rawUrl = file.download_url || file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
  navigator.clipboard.writeText(rawUrl).then(() => {
    showToast('Raw 链接已复制');
  }).catch(e => {
    showToast('复制失败');
    console.error(e);
  });
}
function copyProxyLink(file) {
  if (!file.download_url) return showToast('无代理链接可用');
  const proxyUrl = `${state.proxyUrl}${file.download_url}`;
  navigator.clipboard.writeText(proxyUrl).then(() => {
    showToast('代理链接已复制');
  }).catch(e => {
    showToast('复制失败');
    console.error(e);
  });
}
async function downloadFile(item) {
  if (item.type === 'dir') return;
  try {
    showToast(`准备下载 ${item.name}`);
    const rawUrl = item.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    const url = `${state.proxyUrl}${rawUrl}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`下载失败 (${response.status})`);
    const blob = await response.blob();
    const objectUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = objectUrl;
    a.download = item.name;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(objectUrl);
    }, 500);
    showToast(`开始下载 ${item.name}`);
  } catch (e) {
    showToast(`下载出错: ${e.message}`);
    console.error(e);
  }
}


function downloadRepoAsZip(repo) {
  const zipUrl = `${state.proxyUrl}https://github.com/${repo.full_name}/archive/refs/heads/${repo.default_branch || 'main'}.zip`;
  const a = document.createElement('a');
  a.href = zipUrl;
  a.download = `${repo.name}.zip`;
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => document.body.removeChild(a), 500);
  showToast(`正在下载 ${repo.name}.zip`);
}


const mainMenuBtn = document.getElementById('mainMenuBtn');
const mainMenuPopup = document.getElementById('mainMenuPopup');
mainMenuBtn.onclick = (e) => {
  e.stopPropagation();
  mainMenuPopup.classList.toggle('hidden');
};
document.addEventListener('click', function(e) {
  if (!mainMenuPopup.classList.contains('hidden')) {
    if (!mainMenuPopup.contains(e.target) && e.target !== mainMenuBtn) {
      mainMenuPopup.classList.add('hidden');
    }
  }
});
document.getElementById('menuRepoList').onclick = () => {
  mainMenuPopup.classList.add('hidden');
  showRepoListView();
};
document.getElementById('menuRefresh').onclick = () => {
  mainMenuPopup.classList.add('hidden');
  if (!state.currentRepo) fetchRepos();
  else fetchFiles();
};
document.getElementById('menuLogout').onclick = () => {
  mainMenuPopup.classList.add('hidden');
  localStorage.removeItem('gh_token');
  state.token = null;
  state.repos = [];
  state.currentRepo = null;
  showAuth();
};

function renderPathNav() {
  el.pathNav.innerHTML = '';
  const parts = state.currentPath.split('/').filter(p => p);
  let currentPath = '';
  addPathItem('/', '');
  parts.forEach((part) => {
    currentPath += part + '/';
    addPathItem(part, currentPath);
  });
}
function addPathItem(name, path) {
  const item = document.createElement('span');
  item.className = 'cursor-pointer hover:text-gray-300';
  item.textContent = name;
  item.dataset.path = path;
  item.addEventListener('click', () => {
    el.fileList.innerHTML = '<div class="flex justify-center items-center h-full py-10"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div></div>';
    navigateToPath(path);
  });
  el.pathNav.appendChild(item);
  if (name !== '/') el.pathNav.appendChild(document.createTextNode(' / '));
}


function goUp() {
  if (!state.currentRepo) {
    fetchRepos();
    showToast('已重新载入仓库列表');
    return;
  }
  if (!state.currentPath || state.currentPath === '' || state.currentPath === '/') {
    showRepoListView();
    return;
  }
  let parts = state.currentPath.split('/').filter(Boolean);
  parts.pop();
  state.currentPath = parts.length ? parts.join('/') + '/' : '';
  showToast('已返回上一级');
  fetchFiles();
}
el.backBtn && (el.backBtn.onclick = goUp);

// 登录
el.authBtn.addEventListener('click', () => {
  const token = el.tokenInput.value.trim();
  if (token) {
    localStorage.setItem('gh_token', token);
    state.token = token;
    showApp();
    fetchRepos();
  } else {
    showToast('请输入令牌');
  }
});

// 退出登录
el.logoutBtn && el.logoutBtn.addEventListener('click', () => {
  localStorage.removeItem('gh_token');
  state.token = null;
  state.repos = [];
  state.currentRepo = null;
  showAuth();
});

document.addEventListener('DOMContentLoaded', () => {
  initUploadFeatures();
  initMediaPreview();
  initAudioPlayer();
  state.token ? (showApp(), fetchRepos()) : showAuth();
});





</script>


<script>
async function createFolder() {
  const inRepo = !!state.currentRepo;
  showModal(`
    <div>
      <h3 class="font-bold mb-4">${inRepo ? '新建文件夹' : '新建仓库'}</h3>
      <input id="newName" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4" placeholder="${inRepo ? '输入文件夹名称' : '输入英文仓库名称'}">
      ${!inRepo ? `
        <textarea id="repoDesc" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4 min-h-[120px]" placeholder="输入仓库描述"></textarea>
        <div class="flex items-center mb-4">
          <input type="checkbox" id="isPublic" class="mr-2 accent-green-500" checked>
          <label for="isPublic" class="text-white">公开仓库</label>
        </div>
      ` : ''}
      <div class="flex gap-3">
        <button id="cancelCreate" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
        <button id="confirmCreate" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>确认</button>
      </div>
    </div>
  `);
  const nameInput = document.getElementById('newName');
  const confirmBtn = document.getElementById('confirmCreate');
  const descInput = !inRepo ? document.getElementById('repoDesc') : null;
  const publicCheckbox = !inRepo ? document.getElementById('isPublic') : null;
  nameInput.oninput = () => {
    const name = nameInput.value.trim();
    confirmBtn.disabled = !name;
    confirmBtn.className = name
      ? 'flex-1 p-3 bg-green-600 hover:bg-green-500 text-white rounded'
      : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
  };
  confirmBtn.onclick = async () => {
    const name = nameInput.value.trim();
    if (!name) return;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `创建中<i class="fa fa-spinner fa-spin ml-2"></i>`;
    try {
      if (inRepo) {
        const [owner, repo] = state.currentRepo.split('/');
        const path = state.currentPath ? `${state.currentPath}${name}/.gitkeep` : `${name}/.gitkeep`;
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: `create folder ${name}`, content: '' })
        });
        showToast(`已创建文件夹: ${name}`);
        hideModal();
        fetchFiles();
      } else {
        const description = descInput.value.trim();
        const isPublic = publicCheckbox.checked;
        const res = await fetch(`https://api.github.com/user/repos`, {
          method: 'POST',
          headers: { Authorization: `token ${state.token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            description: description,
            private: !isPublic
          })
        });
        if (!res.ok) throw new Error('创建仓库失败');
        showToast(`已创建仓库: ${name}`);
        hideModal();
        fetchRepos();
      }
    } catch (e) {
      showToast(`失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
    }
  };
  document.getElementById('cancelCreate').onclick = hideModal;
}


async function createFile() {
  if (!state.currentRepo) {
    showToast('请先选择仓库');
    return;
  }
  showModal(`
    <h3 class="font-bold mb-4">新建文件</h3>
    <input id="newFileName" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4" placeholder="输入文件名，如 example.txt">
    <textarea id="newFileContent" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4 min-h-[120px]" placeholder="文件内容（可选）"></textarea>
    <div class="flex gap-3">
      <button id="cancelCreateFile" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
      <button id="confirmCreateFile" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>确认</button>
    </div>
  `);
  const nameInput = document.getElementById('newFileName');
  const contentInput = document.getElementById('newFileContent');
  const confirmBtn = document.getElementById('confirmCreateFile');
  nameInput.oninput = () => {
    const name = nameInput.value.trim();
    const valid = !!name && !name.endsWith('/');
    confirmBtn.disabled = !valid;
    confirmBtn.className = valid
      ? 'flex-1 p-3 bg-green-600 hover:bg-green-500 text-white rounded'
      : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
  };
  confirmBtn.onclick = async () => {
    const name = nameInput.value.trim();
    const content = contentInput.value;
    if (!name) return;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `创建中<i class="fa fa-spinner fa-spin ml-2"></i>`;
    try {
      const [owner, repo] = state.currentRepo.split('/');
      const path = state.currentPath ? `${state.currentPath}${name}` : name;
      const encodedContent = btoa(unescape(encodeURIComponent(content)));
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          Authorization: `token ${state.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `create file ${name}`,
          content: encodedContent
        })
      });
      if (!res.ok) throw new Error('创建失败');
      showToast(`已创建文件: ${name}`);
      hideModal();
      fetchFiles();
    } catch (e) {
      showToast(`失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
    }
  };
  document.getElementById('cancelCreateFile').onclick = hideModal;
}

function handleContextMenuAction(action, file) {
  switch (action) {
    case 'download': downloadFile(file); break;
    case 'copyLink': copyLink(file); break;
    case 'copyProxy': copyProxyLink(file); break;
    case 'edit': editFile(file); break;
    case 'rename': renameItem(file); break;
    case 'delete': deleteItem(file); break;
  }
}
function handleRepoContextMenuAction(action, repo) {
  switch (action) {
    case 'downloadRepo': downloadRepoAsZip(repo); break;
    case 'renameRepo': renameRepo(repo); break;
    case 'deleteRepo': deleteRepo(repo); break;
  }
}

function renameRepo(repo) {
  showModal(`
    <div>
      <h3 class="font-bold mb-4">重命名仓库: ${repo.name}</h3>
      <input id="newRepoName" value="${repo.name}" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4">
      <textarea id="newRepoDesc" class="w-full p-3 rounded bg-[#030712] text-white outline-none mb-4 min-h-[80px]" placeholder="输入仓库描述">${repo.description || ''}</textarea>
      <div class="flex gap-3">
        <button id="cancelRenameRepo" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
        <button id="confirmRenameRepo" class="flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed" disabled>确认</button>
      </div>
    </div>
  `);
  const nameInput = document.getElementById('newRepoName');
  const descInput = document.getElementById('newRepoDesc');
  const confirmBtn = document.getElementById('confirmRenameRepo');
  nameInput.oninput = descInput.oninput = () => {
    const newName = nameInput.value.trim();
    const newDesc = descInput.value.trim();
    const isModified = (newName !== repo.name) || (newDesc !== (repo.description || ''));
    confirmBtn.disabled = !isModified;
    confirmBtn.className = isModified
      ? 'flex-1 p-3 bg-green-600 hover:bg-green-500 text-white rounded'
      : 'flex-1 p-3 bg-gray-600 text-gray-400 rounded cursor-not-allowed';
  };
  confirmBtn.onclick = async () => {
    const newName = nameInput.value.trim();
    const newDesc = descInput.value.trim();
    if (newName === repo.name && newDesc === (repo.description || '')) return;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `处理中<i class="fa fa-spinner fa-spin ml-2"></i>`;
    try {
      const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${state.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName, description: newDesc })
      });
      if (!res.ok) throw new Error((await res.json()).message || '修改失败');
      showToast(`仓库信息已更新`);
      hideModal();
      fetchRepos();
    } catch (e) {
      showToast(`修改失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
    }
  };
  document.getElementById('cancelRenameRepo').onclick = hideModal;
}

function deleteRepo(repo) {
  showModal(`
    <h3 class="font-bold mb-4">确认删除仓库</h3>
    <p class="mb-4 text-gray-300">确定要删除仓库 "${repo.name}" 吗？此操作不可撤销！</p>
    <div class="flex gap-3">
      <button id="cancelDeleteRepo" class="flex-1 p-3 bg-gray-700 rounded">取消</button>
      <button id="confirmDeleteRepo" class="flex-1 p-3 bg-red-600 hover:bg-red-500 text-white rounded">确认删除</button>
    </div>
  `);
  const confirmBtn = document.getElementById('confirmDeleteRepo');
  confirmBtn.onclick = async () => {
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `删除中<i class="fa fa-spinner fa-spin ml-2"></i>`;
    try {
      const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
        method: 'DELETE',
        headers: { 'Authorization': `token ${state.token}` }
      });
      if (!res.ok) throw new Error((await res.json()).message || '删除失败');
      showToast(`仓库 "${repo.name}" 已删除`);
      hideModal();
      fetchRepos();
    } catch (e) {
      showToast(`删除失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认删除';
    }
  };
  document.getElementById('cancelDeleteRepo').onclick = hideModal;
}

// 监听 ESC 关闭模态框
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') hideModal();
});
</script>


<script>
// 多选模式切换按钮（如有）
document.getElementById('multiSelectBtn')?.addEventListener('click', function() {
  if (!state.currentRepo) {
    showToast('请先进入仓库');
    return;
  }
  window._multiSelect.mode = !window._multiSelect.mode;
  if (!window._multiSelect.mode) window._multiSelect.selected = [];
  renderFileList();
});

// 切换仓库/路径时自动退出多选
const origFetchFiles = window.fetchFiles;
window.fetchFiles = function() {
  window._multiSelect.mode = false;
  window._multiSelect.selected = [];
  document.getElementById('multiActionBar').classList.add('hidden');
  origFetchFiles && origFetchFiles.apply(this, arguments);
};
const origShowRepoListView = window.showRepoListView;
window.showRepoListView = function() {
  window._multiSelect.mode = false;
  window._multiSelect.selected = [];
  document.getElementById('multiActionBar').classList.add('hidden');
  origShowRepoListView && origShowRepoListView.apply(this, arguments);
};

// 文件长按右键菜单
document.getElementById('fileList').addEventListener('mousedown', function(e) {
  if (window._multiSelect.mode) return;
  if (!state.currentRepo) return;
  const item = e.target.closest('.file-item');
  if (!item) return;
  let timer = setTimeout(() => {
    window._multiSelect.mode = true;
    window._multiSelect.selected = [];
    renderFileList();
  }, 600);
  item.addEventListener('mouseup', () => clearTimeout(timer), { once: true });
  item.addEventListener('mouseleave', () => clearTimeout(timer), { once: true });
});

// 仓库长按右键菜单
document.getElementById('repoList').addEventListener('mousedown', function(e) {
  const item = e.target.closest('.repo-item');
  if (!item) return;
  let timer = setTimeout(() => {
    // 你可以在这里弹出仓库右键菜单
    // showRepoContextMenu(e, repo);
  }, 600);
  item.addEventListener('mouseup', () => clearTimeout(timer), { once: true });
  item.addEventListener('mouseleave', () => clearTimeout(timer), { once: true });
});

// 媒体预览图片/视频切换
function showMediaPreview(type, url) {
  const p = document.getElementById('mediaPreview');
  const img = p.querySelector('img');
  const video = p.querySelector('video');
  if (type === 'img') {
    img.src = url;
    img.classList.remove('hidden');
    video.classList.add('hidden');
  } else if (type === 'video') {
    video.src = url;
    video.classList.remove('hidden');
    img.classList.add('hidden');
    video.load();
  }
  p.classList.remove('hidden');
}

// 点击空白处关闭右键菜单
document.addEventListener('click', function(e) {
  const menu = document.getElementById('contextMenu');
  if (!menu.classList.contains('hidden') && !menu.contains(e.target)) {
    menu.classList.add('hidden');
  }
});
// 点击空白处关闭主菜单
document.addEventListener('click', function(e) {
  const mainMenuPopup = document.getElementById('mainMenuPopup');
  const mainMenuBtn = document.getElementById('mainMenuBtn');
  if (!mainMenuPopup.classList.contains('hidden')) {
    if (!mainMenuPopup.contains(e.target) && e.target !== mainMenuBtn) {
      mainMenuPopup.classList.add('hidden');
    }
  }
});
// ESC关闭模态框
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') hideModal();
});


function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}




</script>


<script>
// 自动退出多选模式
function exitMultiSelect() {
  window._multiSelect.mode = false;
  window._multiSelect.selected = [];
  document.getElementById('multiActionBar').classList.add('hidden');
  renderFileList();
}
function autoExitMultiSelectOnNav() {
  // 切换仓库
  const origShowRepoListView = window.showRepoListView;
  window.showRepoListView = function() {
    exitMultiSelect();
    origShowRepoListView && origShowRepoListView.apply(this, arguments);
  };
  // 切换路径
  const origFetchFiles = window.fetchFiles;
  window.fetchFiles = function() {
    exitMultiSelect();
    origFetchFiles && origFetchFiles.apply(this, arguments);
  };
}
autoExitMultiSelectOnNav();

// 关闭媒体预览
document.getElementById('mediaPreview').onclick = function() {
  this.classList.add('hidden');
  const img = this.querySelector('img');
  const video = this.querySelector('video');
  img.src = '';
  video.src = '';
  img.classList.add('hidden');
  video.classList.add('hidden');
  video.pause();
};

// 文件项点击/长按事件
function bindFileItemEvents() {
  document.querySelectorAll('.file-item').forEach((item, idx) => {
    // 防止重复绑定
    if (item._binded) return;
    item._binded = true;
    item.addEventListener('click', (e) => {
      if (e.target.classList.contains('multi-select-checkbox')) return;
      const file = state.files[idx];
      if (file.type === 'dir') navigateToDir(file.name);
      else editFile(file);
    });
    // 长按进入多选
    let timer;
    item.addEventListener('mousedown', (e) => {
      if (window._multiSelect.mode) return;
      timer = setTimeout(() => {
        window._multiSelect.mode = true;
        window._multiSelect.selected = [];
        renderFileList();
      }, 600);
    });
    item.addEventListener('mouseup', () => clearTimeout(timer));
    item.addEventListener('mouseleave', () => clearTimeout(timer));
    // 右键菜单
    item.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showContextMenu(e, state.files[idx]);
    });
  });
}
// 仓库项长按右键
function bindRepoItemEvents() {
  document.querySelectorAll('.repo-item').forEach((item, idx) => {
    if (item._binded) return;
    item._binded = true;
    let timer;
    item.addEventListener('mousedown', (e) => {
      timer = setTimeout(() => {
        // showRepoContextMenu(e, state.repos[idx]);
      }, 600);
    });
    item.addEventListener('mouseup', () => clearTimeout(timer));
    item.addEventListener('mouseleave', () => clearTimeout(timer));
    item.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      // showRepoContextMenu(e, state.repos[idx]);
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  initUploadFeatures();
  initMediaPreview();
  initAudioPlayer();
  state.token ? (showApp(), fetchRepos()) : showAuth();
  // 绑定多选操作栏按钮
  document.getElementById('selectAllBtn').onclick = ...; // 见前面
  document.getElementById('invertSelectBtn').onclick = ...;
  document.getElementById('batchDeleteBtn').onclick = ...;
  document.getElementById('batchZipBtn').onclick = ...;
  // 绑定主菜单
  // ...见前面...
  // 绑定返回按钮
  el.backBtn && (el.backBtn.onclick = goUp);
  // 绑定文件/仓库项事件
  bindFileItemEvents();
  bindRepoItemEvents();
});


// 防止多次点击批量操作
let batchActionLock = false;
function safeBatchAction(fn) {
  if (batchActionLock) return;
  batchActionLock = true;
  fn().finally(() => batchActionLock = false);
}
document.getElementById('batchDeleteBtn').onclick = () => safeBatchAction(async () => {
  // ...批量删除逻辑...
});
document.getElementById('batchZipBtn').onclick = () => safeBatchAction(async () => {
  // ...批量打包逻辑...
});


function escapeHtml(unsafe) {
  return unsafe.replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}


document.addEventListener('click', function(e) {
  const menu = document.getElementById('contextMenu');
  if (!menu.classList.contains('hidden') && !menu.contains(e.target)) {
    menu.classList.add('hidden');
  }
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') hideModal();
});






</script>

<script>
document.getElementById('fileList').addEventListener('dblclick', function(e) {
  const item = e.target.closest('.file-item');
  if (!item) return;
  const name = item.querySelector('.file-title').textContent;
  const file = state.files.find(f => f.name === name);
  if (file && file.type === 'file') {
    downloadFile(file);
  }
});

document.addEventListener('keydown', function(e) {
  if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
  // Delete键批量删除
  if (e.key === 'Delete' && window._multiSelect.mode && window._multiSelect.selected.length) {
    document.getElementById('batchDeleteBtn').click();
  }
  // Enter键编辑第一个选中文件
  if (e.key === 'Enter' && window._multiSelect.mode && window._multiSelect.selected.length === 1) {
    const idx = window._multiSelect.selected[0];
    editFile(state.files[idx]);
  }
});

el.fileList.addEventListener('dragover', function(e) {
  e.preventDefault();
  el.fileList.classList.add('dragover');
});
el.fileList.addEventListener('dragleave', function(e) {
  e.preventDefault();
  el.fileList.classList.remove('dragover');
});
el.fileList.addEventListener('drop', function(e) {
  e.preventDefault();
  el.fileList.classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files || []);
  if (files.length) {
    handleFilesSelected({ target: { files } });
  }
});

function showContextMenu(e, file) {
  state.selectedFile = file;
  const menu = el.contextMenu;
  let x = e.clientX, y = e.clientY;
  const menuWidth = 192, menuHeight = 240;
  if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 10;
  if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight - 10;
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.classList.remove('hidden');
  renderContextMenuItems(file);
}

function showGlobalLoading() {
  if (!document.getElementById('globalLoading')) {
    const div = document.createElement('div');
    div.id = 'globalLoading';
    div.innerHTML = '<div class="loading-spinner"></div>';
    document.body.appendChild(div);
  }
  document.getElementById('globalLoading').style.display = 'flex';
}
function hideGlobalLoading() {
  const div = document.getElementById('globalLoading');
  if (div) div.style.display = 'none';
}






</script>

<script>
// 上传功能
function initUploadFeatures() {
  if (window.uploadFeaturesInitialized) return;
  window.uploadFeaturesInitialized = true;
  if (el.uploadBtn) el.uploadBtn.addEventListener('click', handleUploadClick);
  if (el.fileUploadInput) el.fileUploadInput.addEventListener('change', handleFilesSelected);
}

function handleUploadClick() {
  if (!state || !state.currentRepo) {
    showToast('请先选择仓库');
    return;
  }
  if (el.fileUploadInput) {
    el.fileUploadInput.value = '';
    el.fileUploadInput.click();
  }
}

function handleFilesSelected(e) {
  const files = Array.from(e.target.files || []);
  if (files.length === 0) return;
  if (el.uploadPanel) el.uploadPanel.classList.remove('hidden');
  if (el.uploadItems) el.uploadItems.innerHTML = '';
  files.forEach((file, index) => {
    const uploadItem = document.createElement('div');
    uploadItem.className = 'upload-item';
    uploadItem.innerHTML = `
      <div class="upload-item-header">
        <span class="upload-item-name">${file.name}</span>
        <span class="upload-item-size">${formatSize(file.size)}</span>
      </div>
      <div class="upload-progress-bar">
        <div class="upload-progress" data-index="${index}"></div>
      </div>
      <div class="upload-status" data-index="${index}">等待上传...</div>
    `;
    if (el.uploadItems) el.uploadItems.appendChild(uploadItem);
  });
  uploadFilesInSequence(files, 0);
  e.target.value = '';
}

function uploadFilesInSequence(files, index) {
  if (index >= files.length) {
    setTimeout(() => {
      if (el.uploadPanel) el.uploadPanel.classList.add('hidden');
      if (typeof fetchFiles === 'function') fetchFiles();
    }, 2000);
    return;
  }
  const file = files[index];
  const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
  if (statusElement) statusElement.textContent = '准备上传...';
  uploadSingleFile(file, index)
    .then(() => uploadFilesInSequence(files, index + 1))
    .catch(() => uploadFilesInSequence(files, index + 1));
}

async function uploadSingleFile(file, index) {
  return new Promise((resolve, reject) => {
    const progressBar = document.querySelector(`.upload-progress[data-index="${index}"]`);
    const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
    if (progressBar) progressBar.style.width = '5%';
    if (statusElement) statusElement.textContent = '正在处理文件...';

    const reader = new FileReader();
    reader.readAsArrayBuffer(file);
    reader.onload = async (e) => {
      try {
        if (statusElement) statusElement.textContent = '正在编码内容...';
        const base64String = arrayBufferToBase64(e.target.result);
        if (progressBar) progressBar.style.width = '30%';
        if (!state || !state.currentRepo) throw new Error('未选择仓库');
        const fileName = file.name;
        const filePath = state.currentPath ? `${state.currentPath}${fileName}` : fileName;
        const [owner, repo] = state.currentRepo.split('/');
        if (statusElement) statusElement.textContent = '正在上传...';
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${state.token}`,
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0'
          },
          body: JSON.stringify({
            message: `Upload ${fileName}`,
            content: base64String
          }),
          signal: AbortSignal.timeout(60000)
        });
        if (progressBar) progressBar.style.width = '100%';
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `上传失败: HTTP ${response.status}`);
        }
        if (statusElement) {
          statusElement.textContent = '上传成功';
          statusElement.className = 'upload-status upload-success';
        }
        showToast(`文件 "${fileName}" 上传成功`);
        resolve();
      } catch (error) {
        if (statusElement) {
          statusElement.textContent = `失败: ${error.message.substring(0, 20)}...`;
          statusElement.className = 'upload-status upload-fail';
        }
        showToast(`文件 "${file.name}" 上传失败`);
        reject(error);
      }
    };
    reader.onerror = () => {
      if (statusElement) {
        statusElement.textContent = '文件读取失败';
        statusElement.className = 'upload-status upload-fail';
      }
      showToast(`无法读取文件: ${file.name}`);
      reject(new Error('文件读取失败'));
    };
  });
}

// ArrayBuffer转base64
function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

// 工具函数：格式化文件大小
function formatSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 初始化
document.addEventListener('DOMContentLoaded', initUploadFeatures);








</script>

<script>









</script>

<script>









</script>










</body>
</html>