<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub文件管理器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<style>

/* GitHub 图标：深蓝→青绿→亮紫 */
i.fa-github {
  background: linear-gradient(270deg, #0f172a, #06b6d4, #a21caf, #0f172a);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: github-rainbow 4.5s linear infinite;
}
@keyframes github-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 文件夹：亮橙→金黄→浅绿 */
i.fa-folder {
  background: linear-gradient(90deg, #f97316, #facc15, #4ade80, #f97316);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: folder-rainbow 2.2s ease-in-out infinite alternate;
}
@keyframes folder-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 代码文件：深蓝→亮青→亮绿 */
i.fa-code, i.fa-html5, i.fa-css3, i.fa-file-code-o {
  background: linear-gradient(90deg, #2563eb, #06b6d4, #22c55e, #2563eb);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: code-rainbow 1.5s linear infinite;
}
@keyframes code-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 文本/Markdown：亮青→浅紫→白 */
i.fa-file-text-o, i.fa-file-o {
  background: linear-gradient(90deg, #22d3ee, #a5b4fc, #fff, #22d3ee);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: text-rainbow 3.5s linear infinite;
}
@keyframes text-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 图片文件：亮粉→亮橙→亮黄 */
i.fa-file-image-o {
  background: linear-gradient(90deg, #f472b6, #fb7185, #fde68a, #f472b6);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: image-rainbow 2.8s ease-in-out infinite alternate;
}
@keyframes image-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* PDF 文件：深红→亮橙→白 */
i.fa-file-pdf-o {
  background: linear-gradient(90deg, #be123c, #f59e42, #fff, #be123c);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: pdf-rainbow 2.7s linear infinite;
}
@keyframes pdf-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* ZIP 文件：亮紫→亮蓝→亮青 */
i.fa-file-zip-o {
  background: linear-gradient(90deg, #a78bfa, #38bdf8, #22d3ee, #a78bfa);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: zip-rainbow 2.1s ease-in-out infinite alternate;
}
@keyframes zip-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* Git 图标：亮橙→亮红→深红 */
i.fa-git {
  background: linear-gradient(90deg, #f59e42, #ef4444, #991b1b, #f59e42);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: git-rainbow 1.3s linear infinite;
}
@keyframes git-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 操作类图标：亮青→亮蓝→亮紫→亮粉 */
i.fa-download, i.fa-upload, i.fa-refresh, i.fa-plus, i.fa-edit, i.fa-trash, i.fa-link, i.fa-share, i.fa-arrow-up, i.fa-sign-out, i.fa-list, i.fa-times, i.fa-spinner, i.fa-check, i.fa-pencil {
  background: linear-gradient(90deg, #22d3ee, #2563eb, #a21caf, #f472b6, #22d3ee);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: action-rainbow 2.2s linear infinite;
}
@keyframes action-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 其它未覆盖的fa图标：亮蓝→亮紫→亮粉 */
i.fa:not([class*="fa-github"]):not([class*="fa-folder"]):not([class*="fa-code"]):not([class*="fa-html5"]):not([class*="fa-css3"]):not([class*="fa-file-code-o"]):not([class*="fa-file-text-o"]):not([class*="fa-file-o"]):not([class*="fa-file-image-o"]):not([class*="fa-file-pdf-o"]):not([class*="fa-file-zip-o"]):not([class*="fa-git"]):not([class*="fa-download"]):not([class*="fa-upload"]):not([class*="fa-refresh"]):not([class*="fa-plus"]):not([class*="fa-edit"]):not([class*="fa-trash"]):not([class*="fa-link"]):not([class*="fa-share"]):not([class*="fa-arrow-up"]):not([class*="fa-sign-out"]):not([class*="fa-list"]):not([class*="fa-times"]):not([class*="fa-spinner"]):not([class*="fa-check"]):not([class*="fa-pencil"]) {
  background: linear-gradient(90deg, #38bdf8, #a78bfa, #f472b6, #38bdf8);
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: other-rainbow 3.2s linear infinite;
}
@keyframes other-rainbow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 去除移动端点击高亮 */
* {
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    outline: none;
}
/* 基础样式 */
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background-color: #030712;
    color: #f3f4f6;
    min-height: 100vh;
    overflow-x: hidden;
}

/* 登录界面样式 */
#authScreen {
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    justify-content: center;
    gap: 1.5rem;
}

.auth-header {
    text-align: center;
    margin-bottom: 2.5rem;
}

.auth-header i {
    font-size: 3rem;
    color: #9ca3af;
    margin-bottom: 1rem;
}

.auth-header h1 {
    font-size: 1.875rem;
    font-weight: bold;
}

.auth-form {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.75rem;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

#tokenInput {
    box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.3), inset -3px -3px 6px rgba(75, 85, 99, 0.1);
    background-color: #030712;
    border-radius: 0.5rem;
    padding: 0.75rem;
    outline: none;
    color: #f3f4f6;
    border: none;
}

#authBtn {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #6b7280;
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-weight: 500;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
}

#authBtn:hover {
    background-color: #4b5563;
}

/* 主应用界面样式 */
#app {
    
    flex-direction: column;
    height: 100vh;
}

header {
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-left i {
    color: #9ca3af;
}

#currentRepo {
    font-weight: bold;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#mainMenuBtn {
    padding: 0.5rem;
    border-radius: 9999px;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
}

#mainMenuBtn:hover {
    background-color: rgba(107, 114, 128, 0.2);
}

/* 路径导航 */
#pathNavContainer {
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    padding: 0.25rem 0;
    overflow-x: auto;
    white-space: nowrap;
    
}

#pathNav {
    display: flex;
    gap: 0.25rem;
    font-size: 0.75rem;
}

#pathNav span {
    cursor: pointer;
}

#pathNav span:hover {
    color: #d1d5db;
}

/* 主内容区 */
main {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 90px; /* 或更大，视底部栏高度而定 */
}

#repoList, #fileList {
    padding: 0.75rem;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    padding: 2.5rem 0;
}

.spinner {
    animation: spin 1s linear infinite;
    border-radius: 9999px;
    height: 2.5rem;
    width: 2.5rem;
    border-top: 2px solid #9ca3af;
    border-bottom: 2px solid #9ca3af;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* 底部操作栏 */
footer {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    padding: 1.25rem 1rem;
    display: flex;
    justify-content: space-around;
}

footer button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    width: 25%;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
}

footer button i {
    font-size: 1.25rem;
}

/* 编辑文件模态框 */
#editModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 50;
    display: flex; 
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal-content {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.75rem;
    display: flex;
    flex-direction: column;
    width: 100%;
    
    max-width: 80rem;
    min-height: 66vh;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left:0.75rem;
    height: 2%;
    padding-top: 10px; /* 上内边距 */
    padding-bottom: 10px; /* 下内边距 */
    
}

.modal-header h5 {
    font-size: 0.6rem;
    font-weight: bold;
    
    
    
}

#closeEditModal {
    padding: 0.5rem;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 9999px;
    
}

#closeEditModal:hover {
    background-color: rgba(107, 114, 128, 0.2);
}


#editStatus {

    margin: 0.1rem 0;
    border-radius: 0.375rem;
}

.editor-container {
    flex: 1;
    overflow: hidden;
    position: relative;
    display: flex;
    justify-content: center; /* 水平居中 */
    
}


#editorOverlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(17, 24, 39, 0.7);
    z-index: 10;
    border-radius: 0.375rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

#editorOverlay.show {
    opacity: 1;
    pointer-events: auto;
}

#saveNotification {
    position: absolute;
    top: 2.5rem;
    right: 2.5rem;
    background-color: rgba(15, 81, 50, 0.9);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    z-index: 5;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

#saveNotification.show {
    opacity: 1;
    transform: translateY(0);
}

/*  编辑文件*/ 
#fileContent {
    box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.3), inset -3px -3px 6px rgba(75, 85, 99, 0.1);
    background-color: #030712;
    width: 99%;
    height: 100%;

    outline: none;
    min-height: 66vh;
/* 添加这些关键属性 */
    box-sizing: border-box;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow-x: hidden; /* 或auto，如果希望有水平滚动条 */
    max-width: 1200px;
    border-top: 1px solid #374151;
    border-bottom: 1px solid #374151;
    color:#a2a7c7 ;
    resize: none;
    border: none;
}


/* 编辑文件保存按钮大小 */ 
.modal-footer {
    display: flex;
    gap: 0rem;
height:40px;

}

.modal-footer button {
    flex: 1;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    font-size:11px;
    
    
}

#cancelEdit {
    background-color: #111827;
    color: white;
}

#saveEdit {
    background-color: #111827;
    color: white;
    
}

/* 文件上传面板 */
#uploadPanel {
    position: fixed;
    bottom: 5rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    border-radius: 0.5rem;
    padding: 1rem;
    width: 90%;
    max-width: 28rem;
    font-size: 10px;
    z-index: 40;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; 
}
.upload-percent {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.75rem;
    color: #9ca3af;
    font-weight: 500;
}

.upload-progress-container {
    position: relative;
    height: 4px;
    background: #374151;
    border-radius: 4px;
    overflow: hidden;
    margin: 4px 0;
}

.upload-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    font-size: 12px;
    min-width: 0;
}
.upload-name {
    flex: 1 1 0;
    min-width: 0;
    max-width: 70%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: inline-block;
    
}
.upload-size {
    margin-left: 8px;
    color: #9ca3af;
    flex-shrink: 0;
    font-size: 0.95em;
}



#uploadItems {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 10rem;
    overflow-y: auto;
}

/* 通用模态框 */
#modalOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 50;
    
    align-items: center;
    justify-content: center;
}

#modalOverlay .modal-content {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.75rem;
    padding: 1.25rem;
    width: 91.666667%;
    max-width: 28rem;
}

/* 右键菜单 */
#contextMenu {
    position: fixed;
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    border-radius: 0.5rem;
    z-index: 50;
    
    width: 12rem;
}

#contextMenuItems {
    padding: 0.25rem 0;
}

#contextMenuItems a {
    display: block;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    color: white;
    text-decoration: none;
}

#contextMenuItems a:hover {
    background-color: rgba(107, 114, 128, 0.2);
}

#contextMenuItems a i {
    margin-right: 0.5rem;
}

/* Toast提示 */
#toast {
    position: fixed;
    bottom: 5rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    
    z-index: 30;
}

.hidden { display: none !important; }

/* 主菜单弹出框 */
#mainMenuPopup {
    position: fixed;
    top: 4rem;
    right: 1rem;
    z-index: 50;
    background-color: #111827;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #374151;
    
    min-width: 5rem;
    text-align: center;
    font-size: 0.75rem;
}

#mainMenuPopup button {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    color: white;
    text-align: left;
    cursor: pointer;
}

#mainMenuPopup button:hover {
    background-color: #222;
}

/* 文件列表项样式 */
.file-item {
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(75, 85, 99, 0.1);
    background-color: #111827;
    border-radius: 0.5rem;
    padding: 0.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.file-item:hover {
    background-color: rgba(107, 114, 128, 0.1);
}

.file-icon {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background-color: rgba(17, 24, 39, 0.5);
}

.file-info {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.765rem;
}

.file-meta {
    font-size: 0.75rem;
    color: #9ca3af;
    margin-top: 0.25rem;
    /* 添加这些样式 */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* 限制显示2行 */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 多选操作栏 */
#multiActionBar {
    width: 100%;
    position: fixed;
    bottom: 4.5rem;
    padding: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: space-around;
    background-color: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(10px);
    padding: 0.5rem 0;
    z-index: 20;
}

#multiActionBar button {
    width: 14%;
    height: 2.5rem;
    margin: 0.5rem;
    border: none;
    border-radius: 0.5rem;
    background: linear-gradient(90deg, #0ea5e9, #6366f1);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

#selectedCount {
    color: white;
    font-weight: bold;
    font-size: 0.875rem;
    margin: 0 0.5rem;
    text-align: right;
    margin-right: 15%;
}

/* 多选复选框 */
.multi-select-checkbox {
    margin-right: 0.5rem;
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 2.5rem 0;
    color: #9ca3af;
}

.empty-state i {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

/* 媒体预览 */
#mediaPreview {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 60;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

#mediaPreview img, #mediaPreview video {
    max-width: 90%;
    max-height: 90vh;
    object-fit: contain;
    display: block;
    margin: auto;
}



/* 响应式调整 */
@media (max-width: 640px) {
    footer button {
        width: 20%;
    }
    
    #multiActionBar button {
        width: 18%;
    }
}

button:disabled,
button.disabled {
    background: #6b7280 !important;
    color: #ccc !important;
    cursor: not-allowed !important;
    opacity: 0.7;
}

.modal-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem 0;
}
.modal-form h3 {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}
.modal-form input, .modal-form textarea {
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: none;
    background: #030712;
    color: #f3f4f6;
    font-size: 1rem;
}
.modal-buttons {
    display: flex;
    gap: 1rem;
}
button.primary {
    background: #22c55e;
    color: #fff;
}
button.danger {
    background: #ef4444;
    color: #fff;
}



.upload-progress-container {
    height: 4px;
    background: #374151;
    border-radius: 4px;
    overflow: hidden;
    margin: 4px 0;
}


.upload-progress {
    height: 100%;
    width: 0;
    /* 彩色渐变条 */
    background: linear-gradient(90deg, #22c55e, #0ea5e9, #6366f1, #f472b6, #f59e42, #22c55e);
    background-size: 200% 100%;
    animation: rainbow-bar 2s linear infinite;
    transition: width 0.3s;
    border-radius: 4px;
}
@keyframes rainbow-bar {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
}

.upload-status {
    text-align: right;
    
    margin-top: 7px;
}
.upload-status.success { color: #22c55e; }
.upload-status.error { color: #ef4444; }

.text-red-400 { color: #f87171 !important; }

/* 弹窗内容容器 */
.modal-form-container {
    background: #111827;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 1.5px 6px rgba(75,85,99,0.08);
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    max-width: 400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    min-width: 260px;
}

.modal-form-container h3 {
    font-size: 1.2rem;
    font-weight: bold;
    color: #f3f4f6;
    margin-bottom: 0.5rem;
}

.modal-form-container p {
    color: #9ca3af;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.modal-form-container input,
.modal-form-container textarea {
    background: #030712;
    color: #f3f4f6;
    border: 1px solid #374151;
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-size: 1rem;
    outline: none;
    margin-bottom: 0.5rem;
    transition: border 0.2s;
}

.modal-form-container input:focus,
.modal-form-container textarea:focus {
    border-color: #6366f1;
}

.modal-form-container textarea {
    min-height: 80px;
    resize: vertical;
}

.modal-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
}

.modal-buttons button {
    flex: 1;
    padding: 0.75rem 0;
    border-radius: 0.5rem;
    border: none;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

button.primary {
    background: #22c55e;
    color: #fff;
}
button.primary:hover:not(:disabled) {
    background: #16a34a;
}
button.danger {
    background: #ef4444;
    color: #fff;
}
button.danger:hover:not(:disabled) {
    background: #dc2626;
}
button:disabled,
button.disabled {
    background: #6b7280 !important;
    color: #ccc !important;
    cursor: not-allowed !important;
    opacity: 0.7;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

@media (max-width: 480px) {
    .modal-form-container {
        max-width: 95vw;
        padding: 1rem 0.5rem;
    }
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
}
.hidden { display: none !important; }
</style>

<body>
    <!-- 登录界面 -->
    <div id="authScreen">
        <div class="auth-header">
            <i class="fa fa-github"></i>
            <h1>GitHub文件管理器</h1>
        </div>
        <div class="auth-form">
            <input type="text" id="tokenInput" placeholder="输入GitHub访问令牌">
            <button id="authBtn">登录</button>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="app" class="hidden">
        <header>
            <div class="header-left">
                <i class="fa fa-github"></i>
                <h1 id="currentRepo">选择仓库</h1>
            </div>
            <div>
                <button id="mainMenuBtn" title="菜单">
                    <i class="fa fa-github"></i>
                </button>
            </div>
        </header>

        <!-- 路径导航 -->
        <div id="pathNavContainer">
            <div id="pathNav"></div>
        </div>

        <!-- 主内容区 -->
        <main>
            <div id="repoList">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
            <div id="fileList" class="hidden">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>

       
        
        <!-- 重命名弹窗 -->
<div id="renameModal" class="modal-overlay hidden">
  <div class="modal-form-container">
    <h3 id="renameTitle">重命名</h3>
    <input id="renameInput" type="text" value="" autocomplete="off">
    <div id="renameWarn" class="modal-warn"></div>
    <div class="modal-buttons">
      <button id="renameCancel" class="btn btn-cancel">取消</button>
      <button id="renameConfirm" class="btn btn-primary" disabled>确认</button>
    </div>
  </div>
</div>


<!-- 删除弹窗 -->
<div id="deleteModal" class="modal-overlay hidden">
  <div class="modal-form-container">
    <h3 id="deleteTitle">确认删除</h3>
    <p id="deleteDesc"></p>
    <div class="modal-buttons">
      <button id="deleteCancel" class="btn btn-cancel">取消</button>
      <button id="deleteConfirm" class="btn btn-danger">确认删除</button>
    </div>
  </div>
</div>

        <!-- 编辑文件模态框 -->
        <div id="editModal" class="hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="editFileName">编辑文件</h5>
                    <button id="closeEditModal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div id="editStatus"></div>
                <div class="editor-container">
                    <div id="editorOverlay">
                        <div class="spinner-container">
                            <i class="fa fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div id="saveNotification">
                        <i class="fa fa-check"></i> 保存成功
                    </div>
                    <textarea id="fileContent"></textarea>
                </div>
                <div class="modal-footer">
                    <button id="cancelEdit">取消</button>
                    <button id="saveEdit">保存修改</button>
                </div>
            </div>
        </div>

        

        <!-- 通用模态框 -->
        <div id="modalOverlay" class="hidden">
            <div class="modal-content">
                <div id="modalContent"></div>
            </div>
        </div>

        <!-- 右键菜单 -->
        <div id="contextMenu" class="hidden">
            <div id="contextMenuItems"></div>
        </div>

        <!-- Toast提示 -->
        <div id="toast">
            <span id="toastMessage"></span>
        </div>


        <!-- 隐藏的文件上传input -->
        <input type="file" id="fileUploadInput" multiple class="hidden">

        <!-- 主菜单弹出框 -->
        <div id="mainMenuPopup" class="hidden">
            <button id="menuLogout">
                <i class="fa fa-sign-out"></i> 退出登录
            </button>
            <button id="menuRepoList">
                <i class="fa fa-list"></i> 仓库列表
            </button>
              <button id="backBtn">
                <i class="fa fa-arrow-up"></i>返回上级
            </button>
            <button id="newFolderBtn" >
           <i class="fa fa-plus"></i>新建仓库或文件夹
            </button>
            <button id="newFileBtn" >
                <i class="fa fa-file-o"></i>新建文件
            </button>
            <button id="uploadBtn">
                <i class="fa fa-upload"></i>上传文件
            </button>
            <button id="menuRefresh">
                <i class="fa fa-refresh"></i> 刷新页面
            </button>
        </div>
    
    <!-- 媒体预览 -->
<div id="mediaPreview" class="hidden">
    <img id="mediaPreviewImg" style="display:none;" alt="预览图片">
    <video id="mediaPreviewVideo" style="display:none;" controls></video>
</div>

<!-- 新建仓库弹窗 -->
<div id="createRepoModal" class="modal-overlay hidden">
  <div class="modal-form-container">
    <h3>新建仓库</h3>
    <input id="createRepoNameInput" placeholder="输入仓库名称（仅支持英文、数字、连字符）">
    <div id="repoNameError" class="text-red-400" style="font-size: 0.875rem; margin-top: -0.5rem; margin-bottom: 0.5rem; display: none;"></div>
    <textarea id="createRepoDescInput" placeholder="仓库描述（可选）"></textarea>
    <div class="checkbox-container">
      <input type="checkbox" id="createRepoPrivate">
      <label for="createRepoPrivate">公开仓库</label>
    </div>
    <div class="modal-buttons">
      <button id="createRepoCancel" class="btn btn-cancel">取消</button>
      <button id="createRepoConfirm" class="btn btn-primary" disabled>创建仓库</button>
    </div>
  </div>
</div>


<!-- 新建文件夹弹窗 -->
<div id="createFolderModal" class="modal-overlay hidden">
  <div class="modal-form-container">
    <h3>新建文件夹</h3>
    <input id="createFolderInput" placeholder="输入文件夹名称">
    <div class="modal-buttons">
      <button id="createFolderCancel" class="btn btn-cancel">取消</button>
      <button id="createFolderConfirm" class="btn btn-primary" disabled>确认</button>
    </div>
  </div>
</div>


<div id="createFileModal" class="modal-overlay hidden">
  <div class="modal-form-container">
    <h3>新建文件</h3>
    <input id="createFileNameInput" placeholder="输入文件名，如 example.txt">
    <textarea id="createFileContentInput" placeholder="文件内容（可选）"></textarea>
    <div class="modal-buttons">
      <button id="createFileCancel" class="btn btn-cancel">取消</button>
      <button id="createFileConfirm" class="btn btn-primary" disabled>确认</button>
    </div>
  </div>
</div>

<!-- 文件上传面板 -->
<div id="uploadPanel" class="hidden">
  
    <div id="uploadItems" class="scmz"></div>
</div>


    <script>
// ==========================
// 状态管理
// ==========================
const state = {
  token: localStorage.getItem('gh_token') || null,
  currentRepo: null,
  currentPath: '',
  files: [],
  repos: [],
  selectedFile: null,
  selectedRepo: null,
  uploadQueue: [],
  editingFile: null,
  fileSha: '',
  originalContent: '',
  proxyUrl: 'https://gh-proxy.com/',
  navHistory: ['root'],
  fileCache: new Map()
};

// ==========================
// DOM 元素引用
// ==========================
const el = {
  authScreen: document.getElementById('authScreen'),
  app: document.getElementById('app'),
  tokenInput: document.getElementById('tokenInput'),
  authBtn: document.getElementById('authBtn'),
  fileList: document.getElementById('fileList'),
  repoList: document.getElementById('repoList'),
  pathNav: document.getElementById('pathNav'),
  pathNavContainer: document.getElementById('pathNavContainer'),
  currentRepo: document.getElementById('currentRepo'),
  backBtn: document.getElementById('backBtn'),
  newFolderBtn: document.getElementById('newFolderBtn'),
  uploadBtn: document.getElementById('uploadBtn'),
  modalOverlay: document.getElementById('modalOverlay'),
  modalContent: document.getElementById('modalContent'),
  contextMenu: document.getElementById('contextMenu'),
  contextMenuItems: document.getElementById('contextMenuItems'),
  toast: document.getElementById('toast'),
  toastMessage: document.getElementById('toastMessage'),
  uploadPanel: document.getElementById('uploadPanel'),
  uploadItems: document.getElementById('uploadItems'),
  editModal: document.getElementById('editModal'),
  editFileName: document.getElementById('editFileName'),
  fileContent: document.getElementById('fileContent'),
  closeEditModal: document.getElementById('closeEditModal'),
  cancelEdit: document.getElementById('cancelEdit'),
  saveEdit: document.getElementById('saveEdit'),
  editStatus: document.getElementById('editStatus'),
  editorOverlay: document.getElementById('editorOverlay'),
  saveNotification: document.getElementById('saveNotification'),
  fileUploadInput: document.getElementById('fileUploadInput'),
  mainMenuPopup: document.getElementById('mainMenuPopup'),
  menuLogout: document.getElementById('menuLogout'),
  menuRepoList: document.getElementById('menuRepoList'),
  menuRefresh: document.getElementById('menuRefresh'),
  newFileBtn: document.getElementById('newFileBtn'),
  mainMenuBtn: document.getElementById('mainMenuBtn')
};

// ==========================
// 工具函数：获取文件图标
// ==========================
function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    js: 'fa-code',
    html: 'fa-html5',
    css: 'fa-css3',
    json: 'fa-file-code-o',
    md: 'fa-file-text-o',
    png: 'fa-file-image-o',
    jpg: 'fa-file-image-o',
    jpeg: 'fa-file-image-o',
    gif: 'fa-file-image-o',
    pdf: 'fa-file-pdf-o',
    zip: 'fa-file-zip-o',
    git: 'fa-git'
  };
  return icons[ext] || 'fa-file-o';
}

// ==========================
// 工具函数：格式化字节大小
// ==========================
function formatSize(bytes) {
  if (!bytes) return '0 B';
  const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.min(Math.floor(Math.log(bytes) / Math.log(k)), sizes.length - 1);
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ==========================
// 工具函数：相对时间格式化
// ==========================
function formatRelativeTime(date) {
  const diffMs = new Date() - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);
  if (diffMins < 1) return '刚刚';
  if (diffMins < 60) return `${diffMins}分钟前`;
  if (diffHours < 24) return `${diffHours}小时前`;
  if (diffDays < 30) return `${diffDays}天前`;
  return date.toLocaleDateString();
}

// ==========================
// 工具函数：HTML 转义
// ==========================
function escapeHtml(unsafe) {
  return unsafe.replace(/&/g, '&amp;')
    .replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}

// ==========================
// 工具函数：统一 GitHub 请求头
// ==========================
function ghHeaders(extra = {}) {
  return { Authorization: `token ${state.token}`, 'User-Agent': 'Mozilla/5.0', ...extra };
}

// ==========================
// 视图：更新“新建”按钮文案
// ==========================
function updateNewFolderBtnLabel() {
  el.newFolderBtn.innerHTML = state.currentRepo
    ? '<i class="fa fa-folder"></i>新建文件夹'
    : '<i class="fa fa-plus"></i>新建仓库';
}

// ==========================
// 视图：列表切换
// ==========================
function toggleView(showRepoList) {
  if (showRepoList) {
    el.repoList.classList.remove('hidden');
    el.fileList.classList.add('hidden');
    el.pathNavContainer.classList.add('hidden');
    el.currentRepo.textContent = '选择仓库';
  } else {
    el.repoList.classList.add('hidden');
    el.fileList.classList.remove('hidden');
    el.pathNavContainer.classList.remove('hidden');
  }
  updateNewFolderBtnLabel();
}

// ==========================
// 视图：显示登录页
// ==========================
function showAuth() {
  el.authScreen.classList.remove('hidden');
  el.app.classList.add('hidden');
}

// ==========================
// 视图：显示应用页
// ==========================
function showApp() {
  el.authScreen.classList.add('hidden');
  el.app.classList.remove('hidden');
}

// ==========================
// 视图：显示通用模态框
// ==========================
function showModal(content) {
  el.modalContent.innerHTML = content;
  el.modalOverlay.classList.remove('hidden');
}

// ==========================
// 视图：隐藏通用模态框
// ==========================
function hideModal() {
  el.modalOverlay.classList.add('hidden');
  el.modalOverlay.classList.remove('flex');
}

// ==========================
// 视图：Toast 提示
// ==========================
function showToast(message) {
  el.toastMessage.textContent = message;
  el.toast.classList.remove('hidden');
  setTimeout(() => el.toast.classList.add('hidden'), 3000);
}

// ==========================
// 视图：保存成功轻提示
// ==========================
function showSaveNotification() {
  el.saveNotification.classList.add('show');
  setTimeout(() => el.saveNotification.classList.remove('show'), 3000);
}

// ==========================
// 仓库缓存：从缓存加载
// ==========================
function loadReposFromCache() {
  const cachedRepos = localStorage.getItem('cached_repos');
  const cacheTime = localStorage.getItem('repos_cache_time');

  if (cachedRepos && cacheTime) {
    try {
      state.repos = JSON.parse(cachedRepos);
      renderRepoList();
      showRepoListView();
      setTimeout(() => { fetchReposInBackground(); }, 1000);
      return;
    } catch (e) {
      console.error('缓存数据解析失败:', e);
    }
  }
  fetchRepos();
}

// ==========================
// 仓库缓存：后台刷新
// ==========================
async function fetchReposInBackground() {
  try {
    const res = await fetch('https://api.github.com/user/repos?timestamp=' + Date.now(), {
      headers: ghHeaders()
    });
    if (res.ok) {
      const repos = await res.json();
      localStorage.setItem('cached_repos', JSON.stringify(repos));
      localStorage.setItem('repos_cache_time', Date.now().toString());
    }
  } catch (err) {
    console.log('后台更新失败:', err);
  }
}

// ==========================
// 仓库：获取列表
// ==========================
async function fetchRepos() {
  try {
    state.repos = [];
    el.repoList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

    const res = await fetch('https://api.github.com/user/repos?timestamp=' + Date.now(), {
      headers: ghHeaders()
    });
    if (!res.ok) throw new Error('获取仓库失败');

    state.repos = await res.json();
    localStorage.setItem('cached_repos', JSON.stringify(state.repos));
    localStorage.setItem('repos_cache_time', Date.now().toString());

    renderRepoList();
    showRepoListView();
  } catch (err) {
    showToast('加载仓库失败');
    console.error(err);
  }
}

// ==========================
// 仓库：渲染列表
// ==========================
function renderRepoList() {
  state.repos.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
  el.repoList.innerHTML = state.repos.length === 0
    ? '<div class="empty-state"><i class="fa fa-github"></i><p>没有找到仓库</p></div>'
    : '';

  state.repos.forEach(repo => {
    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      <div class="file-icon"><i class="fa fa-github"></i></div>
      <div class="file-info">
        <p class="file-name">${repo.name}</p>
        <p class="file-meta">
          ${repo.private ? '私有仓库' : '公开仓库'}
          ${(repo.size || repo.updated_at) ? ' · ' : ''}
          ${repo.size ? formatSize(repo.size * 1024) : ''}
          ${repo.size && repo.updated_at ? ' · ' : ''}
          ${formatRelativeTime(new Date(repo.updated_at))}
        </p>
        <p class="file-meta">${repo.description || ''}</p>
      </div>
    `;

    item.addEventListener('click', () => {
      state.currentRepo = repo.full_name;
      state.currentPath = '';
      el.currentRepo.textContent = repo.name;
      renderPathNav();
      fetchFiles();
      toggleView(false);
    });

    let pressTimer;
    ['touchstart', 'mousedown'].forEach(event => {
      item.addEventListener(event, (e) => {
        pressTimer = setTimeout(() => {
          e.preventDefault();
          state.selectedRepo = repo;
          showRepoContextMenu(e, repo);
        }, 500);
      });
    });
    ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
      item.addEventListener(event, () => clearTimeout(pressTimer));
    });

    el.repoList.appendChild(item);
  });
}

// ==========================
// 仓库：展示列表视图
// ==========================
function showRepoListView() {
  el.repoList.classList.remove('hidden');
  el.fileList.classList.add('hidden');
  el.pathNavContainer.classList.add('hidden');
  el.currentRepo.textContent = '选择仓库';
  toggleView(true);
  state.currentRepo = null;
  state.currentPath = '';
}

// ==========================
// 文件：获取列表（含缓存）
// ==========================
async function fetchFiles(forceRefresh = false) {
  if (!state.currentRepo) return;
  const cacheKey = `${state.currentRepo}:${state.currentPath}`;

  if (!forceRefresh && state.fileCache.has(cacheKey)) {
    state.files = state.fileCache.get(cacheKey);
    renderFileList();
    setTimeout(() => fetchFilesInBackground(cacheKey), 2000);
    return;
  }

  await fetchFilesFromNetwork(cacheKey);
}

// ==========================
// 文件：网络拉取并缓存
// ==========================
async function fetchFilesFromNetwork(cacheKey) {
  el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
  try {
    const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${Date.now()}`, {
      headers: ghHeaders(),
      cache: 'no-store'
    });
    if (!res.ok) {
      if (res.status === 404) { state.files = []; renderFileList(); return; }
      throw new Error('加载文件失败');
    }
    const data = await res.json();
    if (data.message) throw new Error(data.message);
    state.files = Array.isArray(data) ? data : [];
    state.files.sort((a, b) =>
      a.type === 'dir' && b.type !== 'dir' ? -1 :
      a.type !== 'dir' && b.type === 'dir' ? 1 :
      a.name.localeCompare(b.name)
    );

    state.fileCache.set(cacheKey, [...state.files]);

    await Promise.all(state.files.map(async (file) => {
      try {
        const [owner, repo] = state.currentRepo.split('/');
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/commits?path=${file.path}&per_page=1`, {
          headers: ghHeaders()
        });
        const commits = await res.json();
        if (Array.isArray(commits) && commits.length > 0) {
          file.last_modified = commits[0].commit.committer.date;
        }
      } catch {
        file.last_modified = null;
      }
    }));

    state.fileCache.set(cacheKey, [...state.files]);
    renderFileList();
  } catch (err) {
    if (String(err.message).includes('404')) { state.files = []; renderFileList(); return; }
    showToast('加载文件失败: ' + err.message);
    console.error(err);
  }
}

// ==========================
// 文件：后台静默刷新缓存
// ==========================
async function fetchFilesInBackground(cacheKey) {
  try {
    const res = await fetch(`https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}?t=${Date.now()}`, {
      headers: ghHeaders(),
      cache: 'no-store'
    });
    if (res.ok) {
      const data = await res.json();
      if (!data.message && Array.isArray(data)) {
        const files = data.sort((a, b) =>
          a.type === 'dir' && b.type !== 'dir' ? -1 :
          a.type !== 'dir' && b.type === 'dir' ? 1 :
          a.name.localeCompare(b.name)
        );
        state.fileCache.set(cacheKey, [...files]);
      }
    }
  } catch (err) {
    console.log('后台文件更新失败:', err);
  }
}

// ==========================
// 文件：渲染文件列表
// ==========================
function renderFileList() {
  el.fileList.innerHTML = state.files.length === 0
    ? '<div class="empty-state"><i class="fa fa-github"></i><p>仓库为空</p></div>'
    : '';

  state.files.forEach((file) => {
    const isDir = file.type === 'dir';
    const icon = isDir ? 'fa-folder' : getFileIcon(file.name);
    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      <div class="file-icon"><i class="fa ${icon}"></i></div>
      <div class="file-info">
        <p class="file-name">${file.name}</p>
        <p class="file-meta">
          ${isDir ? '文件夹' : formatSize(file.size)} · 
          ${file.last_modified ? formatRelativeTime(new Date(file.last_modified)) : '加载中'}
        </p>
      </div>
    `;

    item.addEventListener('click', (e) => {
      if (e.imagePreviewAction) return;
      isDir ? navigateToDir(file.name) : editFile(file);
    });

    let pressTimer;
    ['touchstart', 'mousedown'].forEach(event => {
      item.addEventListener(event, (e) => {
        pressTimer = setTimeout(() => {
          e.preventDefault();
          showContextMenu(e, file);
        }, 700);
      });
    });
    ['touchend', 'touchcancel', 'mouseup', 'mouseleave'].forEach(event => {
      item.addEventListener(event, () => clearTimeout(pressTimer));
    });

    el.fileList.appendChild(item);
  });
}

// ==========================
// 路径导航：渲染路径
// ==========================
function renderPathNav() {
  el.pathNav.innerHTML = '';
  const parts = state.currentPath.split('/').filter(p => p);
  let currentPath = '';
  addPathItem('/', '');
  parts.forEach((part) => {
    currentPath += part + '/';
    addPathItem(part, currentPath);
  });
}

// ==========================
// 路径导航：添加单段
// ==========================
function addPathItem(name, path) {
  const item = document.createElement('span');
  item.className = 'path-item';
  item.textContent = name;
  item.dataset.path = path;
  item.addEventListener('click', () => {
    el.fileList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    navigateToPath(path);
  });
  el.pathNav.appendChild(item);
  if (name !== '/') el.pathNav.appendChild(document.createTextNode(' / '));
}

// ==========================
// 路径导航：进入子目录
// ==========================
function navigateToDir(dirName) {
  const newPath = state.currentPath ? `${state.currentPath}${dirName}/` : `${dirName}/`;
  state.navHistory.push(newPath);
  state.currentPath = newPath;
  renderPathNav();
  fetchFiles();
}

// ==========================
// 路径导航：跳转到路径
// ==========================
function navigateToPath(path) {
  state.navHistory.push(path);
  state.currentPath = path;
  renderPathNav();
  fetchFiles();
}

// ==========================
// 编辑器：显示编辑框
// ==========================
function showEditModal() {
  el.editModal.classList.remove('hidden');
  el.editModal.classList.add('flex');
  el.editorOverlay.classList.add('show');
  setTimeout(adjustEditorDimensions, 10);
  el.closeEditModal.onclick = hideEditModal;
  el.cancelEdit.onclick = hideEditModal;
}

// ==========================
// 编辑器：隐藏编辑框
// ==========================
function hideEditModal() {
  el.editModal.classList.add('hidden');
  el.editModal.classList.remove('flex');
  state.editingFile = state.fileSha = state.originalContent = '';
  el.saveEdit.className = 'save-btn';
}

// ==========================
// 编辑器：状态提示
// ==========================
function showEditStatus(text, type) {
  el.editStatus.textContent = text;
  el.editStatus.className = `edit-status ${type}`;
}

// ==========================
// 编辑器：尺寸自适应
// ==========================
function adjustEditorDimensions() {
  const viewportHeight = window.innerHeight;
  const targetEditorHeight = viewportHeight * 0.6;
  const modal = el.editModal.querySelector('.modal-content');
  const otherElementsHeight =
    modal.querySelector('.modal-header').offsetHeight +
    el.editStatus.offsetHeight +
    modal.querySelector('.modal-footer').offsetHeight + 30;
  modal.style.height = `${targetEditorHeight + otherElementsHeight}px`;
  el.fileContent.style.height = `${targetEditorHeight}px`;
}

// ==========================
// 编辑器：读取并打开文件
// ==========================
async function editFile(file) {
  state.editingFile = file;
  el.editFileName.textContent = `${file.name}`;
  el.fileContent.value = '';
  showEditStatus('', '');
  showEditModal();

  try {
    const [owner, repo] = state.currentRepo.split('/');
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
      headers: ghHeaders()
    });

    if (!res.ok) {
      const err = await res.json();
      el.editorOverlay.classList.remove('show');
      showEditStatus(`加载失败：${err.message}`, 'error');
      return;
    }

    const data = await res.json();
    const content = decodeURIComponent(escape(atob(data.content)));
    el.fileContent.value = content;
    state.originalContent = content;
    state.fileSha = data.sha;
    el.editorOverlay.classList.remove('show');
    el.fileContent.oninput = checkContentChanges;
  } catch (e) {
    el.editorOverlay.classList.remove('show');
    showEditStatus(`错误：${e.message}`, 'error');
    console.error(e);
  }
}

// ==========================
// 编辑器：检测内容变更
// ==========================
function checkContentChanges() {
  const isModified = el.fileContent.value !== state.originalContent;
  el.saveEdit.className = isModified ? 'save-btn modified' : 'save-btn';
}

// ==========================
// 编辑器：保存修改内容
// ==========================
async function saveEditedFile() {
  if (!state.editingFile || !state.fileSha) return;
  const currentContent = el.fileContent.value;
  if (currentContent === state.originalContent) {
    showToast('未检测到修改');
    return;
  }

  el.editorOverlay.classList.add('show');

  try {
    const [owner, repo] = state.currentRepo.split('/');
    const encodedContent = btoa(unescape(encodeURIComponent(currentContent)));
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${state.editingFile.path}`, {
      method: 'PUT',
      headers: ghHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        message: `Update ${state.editingFile.name} via web editor`,
        content: encodedContent,
        sha: state.fileSha
      })
    });

    if (!res.ok) {
      const err = await res.json();
      el.editorOverlay.classList.remove('show');
      showEditStatus(`保存失败：${err.message}`, 'error');
      return;
    }

    const result = await res.json();
    state.fileSha = result.content.sha;
    state.originalContent = currentContent;
    el.editorOverlay.classList.remove('show');
    showToast('文件已保存');
    showSaveNotification();
    fetchFiles(true);
    el.saveEdit.className = 'save-btn';
  } catch (e) {
    el.editorOverlay.classList.remove('show');
    showEditStatus(`错误：${e.message}`, 'error');
    console.error(e);
  }
}

// ==========================
// 文件操作：下载文件
// ==========================
async function downloadFile(item) {
  if (item.type === 'dir') return;

  try {
    showToast(`准备下载 ${item.name}`);
    const rawUrl = item.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
    const url = `${state.proxyUrl}${rawUrl}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`下载失败 (${response.status})`);
    const blob = await response.blob();
    const objectUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = objectUrl;
    a.download = item.name;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(objectUrl);
    }, 500);
    showToast(`开始下载 ${item.name}`);
  } catch (e) {
    showToast(`下载出错: ${e.message}`);
    console.error(e);
  }
}

// ==========================
// 文件操作：复制直链
// ==========================
function copyLink(file) {
  const rawUrl = file.download_url || file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
  navigator.clipboard.writeText(rawUrl).then(() => {
    showToast('Raw 链接已复制');
  }).catch(e => {
    showToast('复制失败');
    console.error(e);
  });
}

// ==========================
// 文件操作：复制代理链接
// ==========================
function copyProxyLink(file) {
  if (!file.download_url) return showToast('无代理链接可用');
  const proxyUrl = `${state.proxyUrl}${file.download_url}`;
  navigator.clipboard.writeText(proxyUrl).then(() => {
    showToast('代理链接已复制');
  }).catch(e => {
    showToast('复制失败');
    console.error(e);
  });
}

// ==========================
// 菜单：计算菜单位置
// ==========================
function positionContextMenu(e) {
  const rect = e.target.closest('.file-item').getBoundingClientRect();
  const menuWidth = 192, windowWidth = window.innerWidth, windowHeight = window.innerHeight;
  let leftPos = rect.right + menuWidth + 10 <= windowWidth ? rect.right + 10
    : rect.left - menuWidth - 10 >= 0 ? rect.left - menuWidth - 10
      : Math.max(10, Math.min(windowWidth - menuWidth - 10, (rect.left + rect.right - menuWidth) / 2));
  let topPos = rect.top;
  const estimatedMenuHeight = 40 * 8;
  if (topPos + estimatedMenuHeight > windowHeight) {
    topPos = Math.max(20, windowHeight - estimatedMenuHeight - 40);
  }
  return { top: topPos, left: leftPos };
}

// ==========================
// 菜单：显示文件右键菜单
// ==========================
function showContextMenu(e, file) {
  state.selectedFile = file;
  const position = positionContextMenu(e);
  const menu = el.contextMenu;
  menu.style.top = `${position.top}px`;
  menu.style.left = `${position.left}px`;
  menu.style.opacity = '0';
  menu.style.transform = 'scale(0.8)';
  menu.classList.remove('hidden');
  let start = null, duration = 150;
  function animate(timestamp) {
    if (!start) start = timestamp;
    const progress = Math.min((timestamp - start) / duration, 1);
    menu.style.opacity = progress.toString();
    menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
    if (progress < 1) requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
  renderContextMenuItems(file);
}

// ==========================
// 菜单：显示仓库右键菜单
// ==========================
function showRepoContextMenu(e, repo) {
  state.selectedRepo = repo;
  const position = positionContextMenu(e);
  const menu = el.contextMenu;
  menu.style.top = `${position.top}px`;
  menu.style.left = `${position.left}px`;
  menu.style.opacity = '0';
  menu.style.transform = 'scale(0.8)';
  menu.classList.remove('hidden');
  let start = null, duration = 150;
  function animate(timestamp) {
    if (!start) start = timestamp;
    const progress = Math.min((timestamp - start) / duration, 1);
    menu.style.opacity = progress.toString();
    menu.style.transform = `scale(${0.8 + 0.2 * progress})`;
    if (progress < 1) requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
  renderRepoContextMenuItems(repo);
}

// ==========================
// 菜单：渲染仓库菜单项
// ==========================
function renderRepoContextMenuItems(repo) {
  el.contextMenuItems.innerHTML = '';
  [
    ['downloadRepo', 'fa-download', '下载ZIP (代理)'],
    ['renameRepo', 'fa-pencil', '重命名'],
    ['deleteRepo', 'fa-trash', '删除', 'text-red-400']
  ].forEach(([action, icon, text, className = '']) => {
    const item = document.createElement('a');
    item.className = `context-menu-item ${className}`;
    item.dataset.action = action;
    item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
    item.addEventListener('click', () => {
      handleRepoContextMenuAction(action, state.selectedRepo);
      hideContextMenu();
    });
    el.contextMenuItems.appendChild(item);
  });
}

// ==========================
// 菜单：渲染文件菜单项
// ==========================
function renderContextMenuItems(file) {
  el.contextMenuItems.innerHTML = '';
  const isDir = file.type === 'dir';
  const items = isDir
    ? [
      ['rename', 'fa-pencil', '重命名'],
      ['delete', 'fa-trash', '删除', 'text-red-400']
    ]
    : [
      ['download', 'fa-download', '下载'],
      ['copyLink', 'fa-link', '复制链接'],
      ['copyProxy', 'fa-share', '代理链接'],
      ['edit', 'fa-edit', '编辑'],
      ['rename', 'fa-pencil', '重命名'],
      ['delete', 'fa-trash', '删除', 'text-red-400']
    ];
  items.forEach(([action, icon, text, className = '']) => {
    const item = document.createElement('a');
    item.className = `context-menu-item ${className}`;
    item.dataset.action = action;
    item.innerHTML = `<i class="fa ${icon} mr-2"></i>${text}`;
    item.addEventListener('click', () => {
      handleContextMenuAction(action, state.selectedFile);
      hideContextMenu();
    });
    el.contextMenuItems.appendChild(item);
  });
}

// ==========================
// 菜单：隐藏右键菜单
// ==========================
const hideContextMenu = () => {
  const menu = el.contextMenu;
  if (menu.classList.contains('hidden')) return;
  let start = null, duration = 150;
  function animate(timestamp) {
    if (!start) start = timestamp;
    const progress = Math.min((timestamp - start) / duration, 1);
    menu.style.opacity = (1 - progress).toString();
    menu.style.transform = `scale(${1 - 0.2 * progress})`;
    if (progress < 1) requestAnimationFrame(animate);
    else {
      menu.classList.add('hidden');
      state.selectedFile = null;
      state.selectedRepo = null;
    }
  }
  requestAnimationFrame(animate);
};

// ==========================
// 菜单：文件菜单行为分发
// ==========================
function handleContextMenuAction(action, file) {
  switch (action) {
    case 'download': downloadFile(file); break;
    case 'copyLink': copyLink(file); break;
    case 'copyProxy': copyProxyLink(file); break;
    case 'edit': editFile(file); break;
    case 'rename': showRenameModal(file, file.type === 'dir'); break;
    case 'delete': showDeleteModal(file, file.type === 'dir'); break;
  }
}

// ==========================
// 菜单：仓库菜单行为分发
// ==========================
function handleRepoContextMenuAction(action, repo) {
  switch (action) {
    case 'downloadRepo': downloadRepoAsZip(repo); break;
    case 'renameRepo': renameRepo(repo); break;
    case 'deleteRepo': deleteRepo(repo); break;
  }
}

// ==========================
// 仓库：下载为 ZIP
// ==========================
function downloadRepoAsZip(repo) {
  const zipUrl = `${state.proxyUrl}https://github.com/${repo.full_name}/archive/refs/heads/${repo.default_branch || 'main'}.zip`;
  const a = document.createElement('a');
  a.href = zipUrl;
  a.download = `${repo.name}.zip`;
  a.classList.add('hidden');
  document.body.appendChild(a);
  a.click();
  setTimeout(() => document.body.removeChild(a), 500);
  showToast(`正在下载 ${repo.name}.zip`);
}

// ==========================
// 上传：打开文件选择器
// ==========================
function handleUploadClick() {
  if (!state.currentRepo) {
    showToast('请先选择仓库');
    return;
  }
  el.fileUploadInput.click();
}

// ==========================
// 上传：选择文件后处理
// ==========================
function handleFilesSelected(e) {
  const files = Array.from(e.target.files || []);
  if (files.length === 0) return;

  el.uploadPanel.classList.remove('hidden');
  el.uploadItems.innerHTML = '';

  files.forEach((file, index) => {
    let displayName = file.name;
    if (displayName.length > 25) {
      displayName = displayName.slice(0, 22) + '...';
    }
    const uploadItem = document.createElement('div');
    uploadItem.className = 'upload-item';
    uploadItem.innerHTML = `
      <div class="upload-info">
        <span class="upload-name" title="${file.name}">${displayName}</span>
        <span class="upload-size">${formatSize(file.size)}</span>
      </div>
      <div class="upload-progress-container" style="position:relative;">
        <div class="upload-progress" data-index="${index}"></div>
        <span class="upload-percent" data-index="${index}">0%</span>
      </div>
      <div class="upload-status" data-index="${index}">等待上传...</div>
    `;
    el.uploadItems.appendChild(uploadItem);
  });

  uploadFilesInSequence(files, 0);
  e.target.value = '';
}

// ==========================
// 上传：按顺序上传多个文件
// ==========================
function uploadFilesInSequence(files, index) {
  if (index >= files.length) {
    setTimeout(() => {
      el.uploadPanel.classList.add('hidden');
      fetchFiles(true);
    }, 2000);
    return;
  }

  const file = files[index];
  const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
  if (statusElement) statusElement.textContent = '准备上传...';

  uploadSingleFile(file, index)
    .then(() => uploadFilesInSequence(files, index + 1))
    .catch(() => uploadFilesInSequence(files, index + 1));
}

// ==========================
// 上传：单个文件上传
// ==========================
async function uploadSingleFile(file, index) {
  return new Promise((resolve, reject) => {
    const progressBar = document.querySelector(`.upload-progress[data-index="${index}"]`);
    const statusElement = document.querySelector(`.upload-status[data-index="${index}"]`);
    const percentEl = document.querySelector(`.upload-percent[data-index="${index}"]`);

    if (progressBar) progressBar.style.width = '5%';
    if (statusElement) statusElement.textContent = '正在处理文件...';
    if (percentEl) percentEl.textContent = '5%';

    const reader = new FileReader();
    reader.readAsArrayBuffer(file);

    reader.onload = async (e) => {
      try {
        if (statusElement) statusElement.textContent = '正在编码内容...';
        const base64String = arrayBufferToBase64(e.target.result);
        if (progressBar) progressBar.style.width = '30%';
        if (percentEl) percentEl.textContent = '30%';

        if (!state || !state.currentRepo) throw new Error('未选择仓库');
        const fileName = file.name;
        const filePath = state.currentPath ? `${state.currentPath}${fileName}` : fileName;
        const [owner, repo] = state.currentRepo.split('/');

        if (statusElement) statusElement.textContent = '正在上传...';

        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
          method: 'PUT',
          headers: ghHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({
            message: `Upload ${fileName}`,
            content: base64String
          }),
          signal: AbortSignal.timeout(60000)
        });

        if (progressBar) progressBar.style.width = '100%';
        if (percentEl) percentEl.textContent = '100%';

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `上传失败: HTTP ${response.status}`);
        }

        if (statusElement) {
          statusElement.textContent = '上传成功';
          statusElement.className = 'upload-status success';
        }

        fetchFiles(true);
        resolve();
      } catch (error) {
        if (statusElement) {
          statusElement.textContent = '上传失败';
          statusElement.className = 'upload-status error';
        }
        reject(error);
      }
    };

    reader.onerror = () => {
      if (statusElement) {
        statusElement.textContent = '文件读取失败';
        statusElement.className = 'upload-status error';
      }
      showToast(`无法读取文件: ${file.name}`);
      reject(new Error('文件读取失败'));
    };
  });
}

// ==========================
// 上传：ArrayBuffer 转 Base64
// ==========================
function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

// ==========================
// 弹窗：重命名文件/文件夹
// ==========================
function showRenameModal(item, isDir) {
  document.getElementById('renameTitle').textContent = `重命名${isDir ? '文件夹' : '文件'}: ${item.name}`;
  const input = document.getElementById('renameInput');
  input.value = item.name;
  document.getElementById('renameWarn').innerHTML = '';
  document.getElementById('renameModal').classList.remove('hidden');
  const confirmBtn = document.getElementById('renameConfirm');
  const cancelBtn = document.getElementById('renameCancel');

  input.oninput = function () {
    confirmBtn.disabled = !input.value.trim() || input.value.trim() === item.name;
  };

  cancelBtn.onclick = function () {
    document.getElementById('renameModal').classList.add('hidden');
  };

  confirmBtn.onclick = async function () {
    const v = input.value.trim();
    if (!v || v === item.name) return;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '保存中 <i class="fa fa-spinner fa-spin"></i>';

    try {
      const [owner, repo] = state.currentRepo.split('/');
      const oldPath = item.path;
      const base = oldPath.slice(0, -item.name.length);
      const newPath = base + v;

      if (isDir) {
        const getAll = async p => {
          const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${p}`, {
            headers: ghHeaders()
          });
          if (!r.ok) return [];
          let a = [];
          for (const i of await r.json()) a.push(...(i.type === 'dir' ? await getAll(i.path) : [i]));
          return a;
        };
        const files = await getAll(oldPath);
        for (const f of files) {
          const to = f.path.replace(oldPath, newPath);
          const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
            headers: ghHeaders()
          })).json();
          await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${to}`, {
            method: 'PUT',
            headers: ghHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({
              message: `Move ${f.name}`,
              content: d.content || '',
              sha: d.sha
            })
          });
          await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${f.path}`, {
            method: 'DELETE',
            headers: ghHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({
              message: `Delete ${f.name}`,
              sha: d.sha
            })
          });
        }
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
          method: 'DELETE',
          headers: ghHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({
            message: `Delete folder ${item.name}`,
            sha: item.sha
          })
        });
      } else {
        const d = await (await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
          headers: ghHeaders()
        })).json();
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${newPath}`, {
          method: 'PUT',
          headers: ghHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({
            message: `Rename to ${v}`,
            content: d.content,
            sha: d.sha
          })
        });
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${oldPath}`, {
          method: 'DELETE',
          headers: ghHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({
            message: `Delete old file`,
            sha: d.sha
          })
        });
      }

      showToast(`重命名成功: ${v}`);
      document.getElementById('renameModal').classList.add('hidden');
      fetchFiles(true);
    } catch (e) {
      showToast(`失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
    }
  };
}

// ==========================
// 弹窗：新建文件夹
// ==========================
function showCreateFolderModal() {
  document.getElementById('createFolderInput').value = '';
  document.getElementById('createFolderModal').classList.remove('hidden');
  const input = document.getElementById('createFolderInput');
  const confirmBtn = document.getElementById('createFolderConfirm');
  const cancelBtn = document.getElementById('createFolderCancel');

  input.oninput = function () {
    confirmBtn.disabled = !input.value.trim();
  };

  cancelBtn.onclick = function () {
    document.getElementById('createFolderModal').classList.add('hidden');
  };

  confirmBtn.onclick = async function () {
    const name = input.value.trim();
    if (!name) return;

    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';

    try {
      const [owner, repo] = state.currentRepo.split('/');
      const path = state.currentPath ? `${state.currentPath}${name}` : name;

      await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}/.gitkeep`, {
        method: 'PUT',
        headers: ghHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify({
          message: `create folder ${name}`,
          content: ''
        })
      });

      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
      showToast(`已创建文件夹: ${name}`);
      document.getElementById('createFolderModal').classList.add('hidden');
      fetchFiles(true);
    } catch (e) {
      showToast(`失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
    }
  };
}

// ==========================
// 弹窗：新建文件
// ==========================
function showCreateFileModal() {
  if (!state.currentRepo) {
    showToast('请先选择仓库');
    return;
  }
  document.getElementById('createFileNameInput').value = '';
  document.getElementById('createFileContentInput').value = '';
  document.getElementById('createFileModal').classList.remove('hidden');
  const nameInput = document.getElementById('createFileNameInput');
  const contentInput = document.getElementById('createFileContentInput');
  const confirmBtn = document.getElementById('createFileConfirm');
  const cancelBtn = document.getElementById('createFileCancel');

  nameInput.oninput = function () {
    confirmBtn.disabled = !nameInput.value.trim() || nameInput.value.trim().endsWith('/');
  };

  cancelBtn.onclick = function () {
    document.getElementById('createFileModal').classList.add('hidden');
  };

  confirmBtn.onclick = async function () {
    const name = nameInput.value.trim();
    const content = contentInput.value;
    if (!name) return;

    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';

    try {
      const [owner, repo] = state.currentRepo.split('/');
      const path = state.currentPath ? `${state.currentPath}${name}` : name;
      const encodedContent = btoa(unescape(encodeURIComponent(content)));
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: ghHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify({
          message: `create file ${name}`,
          content: encodedContent
        })
      });
      if (!res.ok) throw new Error('创建失败');
      showToast(`已创建文件: ${name}`);
      document.getElementById('createFileModal').classList.add('hidden');
      fetchFiles(true);
    } catch (e) {
      showToast(`失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
    }
  };
}

// ==========================
// 仓库：重命名仓库
// ==========================
function renameRepo(repo) {
  showModal(`
    <div class="modal-form">
      <h3>重命名仓库: ${repo.name}</h3>
      <input id="newRepoName" value="${repo.name}">
      <textarea id="newRepoDesc">${repo.description || ''}</textarea>
      <div class="modal-buttons">
        <button id="cancelRenameRepo">取消</button>
        <button id="confirmRenameRepo" disabled>确认</button>
      </div>
    </div>
  `);

  const nameInput = document.getElementById('newRepoName');
  const descInput = document.getElementById('newRepoDesc');
  const confirmBtn = document.getElementById('confirmRenameRepo');

  const updateButtonState = () => {
    const newName = nameInput.value.trim();
    const newDesc = descInput.value.trim();
    const isModified = (newName !== repo.name) || (newDesc !== (repo.description || ''));
    confirmBtn.disabled = !isModified;
    confirmBtn.className = isModified ? 'primary' : 'disabled';
  };

  nameInput.oninput = updateButtonState;
  descInput.oninput = updateButtonState;

  confirmBtn.onclick = async () => {
    const newName = nameInput.value.trim();
    const newDesc = descInput.value.trim();
    if (newName === repo.name && newDesc === (repo.description || '')) return;

    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '处理中 <i class="fa fa-spinner fa-spin"></i>';

    try {
      const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
        method: 'PATCH',
        headers: ghHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify({ name: newName, description: newDesc })
      });

      if (!res.ok) throw new Error((await res.json()).message || '修改失败');

      showToast('保存成功');
      hideModal();
      state.repos = [];
      el.repoList.innerHTML = '';
      fetchRepos();
    } catch (e) {
      showToast(`修改失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认';
    }
  };

  document.getElementById('cancelRenameRepo').onclick = hideModal;
}

// ==========================
// 仓库：删除仓库
// ==========================
function deleteRepo(repo) {
  showModal(`
    <div class="modal-form">
      <h3>确认删除仓库</h3>
      <p>确定要删除仓库 "${repo.name}" 吗？此操作不可撤销！</p>
      <div class="modal-buttons">
        <button id="cancelDeleteRepo">取消</button>
        <button id="confirmDeleteRepo" class="danger">确认删除</button>
      </div>
    </div>
  `);

  const confirmBtn = document.getElementById('confirmDeleteRepo');
  confirmBtn.onclick = async () => {
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '删除中 <i class="fa fa-spinner fa-spin"></i>';

    try {
      const res = await fetch(`https://api.github.com/repos/${repo.full_name}`, {
        method: 'DELETE',
        headers: ghHeaders()
      });

      if (!res.ok) throw new Error((await res.json()).message || '删除失败');

      showToast(`仓库 "${repo.name}" 已删除`);
      hideModal();
      fetchRepos();
    } catch (e) {
      showToast(`删除失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认删除';
    }
  };

  document.getElementById('cancelDeleteRepo').onclick = hideModal;
}

// ==========================
// 弹窗：删除文件/文件夹
// ==========================
function showDeleteModal(item, isDir) {
  document.getElementById('deleteTitle').textContent = '确认删除';
  document.getElementById('deleteDesc').textContent = isDir
    ? `确定要删除文件夹 "${item.name}" 吗？这将删除该文件夹及其所有内容。`
    : `确定要删除文件 "${item.name}" 吗？此操作不可撤销。`;
  document.getElementById('deleteModal').classList.remove('hidden');

  document.getElementById('deleteCancel').onclick = function () {
    document.getElementById('deleteModal').classList.add('hidden');
  };

  document.getElementById('deleteConfirm').onclick = async function () {
    const confirmBtn = this;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '处理中 <i class="fa fa-spinner fa-spin"></i>';

    const deleteFile = async (path, sha, name) => {
      const [owner, repo] = state.currentRepo.split('/');
      const res = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
        {
          method: 'DELETE',
          headers: ghHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({
            message: `Delete ${name}`,
            sha: sha
          })
        }
      );
      if (!res.ok) {
        const errorData = await res.json();
        if (res.status === 409) {
          throw new Error(`操作冲突：${errorData.message || '请刷新后重试'}`);
        } else {
          throw new Error(errorData.message || `删除失败 (HTTP ${res.status})`);
        }
      }
    };

    const getAllFiles = async (path) => {
      const [owner, repo] = state.currentRepo.split('/');
      let allFiles = [];
      let page = 1;
      let hasMore = true;
      while (hasMore) {
        const res = await fetch(
          `https://api.github.com/repos/${owner}/${repo}/contents/${path}?page=${page}&per_page=100`,
          { headers: ghHeaders() }
        );
        if (!res.ok) return [];
        const items = await res.json();
        if (!Array.isArray(items)) return [];
        for (const i of items) {
          if (i.type === 'dir') {
            const subFiles = await getAllFiles(i.path);
            allFiles = [...allFiles, ...subFiles];
          } else {
            allFiles.push(i);
          }
        }
        const linkHeader = res.headers.get('Link');
        hasMore = linkHeader && linkHeader.includes('rel="next"');
        page++;
      }
      return allFiles;
    };

    try {
      const targetPath = item.path;
      const safeName = escapeHtml(item.name);

      if (isDir) {
        const allFiles = await getAllFiles(targetPath);
        for (const f of allFiles) {
          await deleteFile(f.path, f.sha, f.name);
        }
        showToast(`文件夹"${safeName}"已删除`);
      } else {
        await deleteFile(targetPath, item.sha, item.name);
        showToast(`文件"${safeName}"已删除`);
      }

      document.getElementById('deleteModal').classList.add('hidden');
      fetchFiles(true);
    } catch (error) {
      showToast(`删除失败: ${error.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '确认删除';
    }
  };
}

// ==========================
// 导航：返回上级
// ==========================
function goUp() {
  if (!state.currentRepo) {
    history.pushState(null, '', window.location.href);
    return;
  }
  if (!state.currentPath || state.currentPath === '' || state.currentPath === '/') {
    showRepoListView();
    return;
  }
  let parts = state.currentPath.split('/').filter(Boolean);
  parts.pop();
  state.currentPath = parts.length ? parts.join('/') + '/' : '';
  renderPathNav();
  fetchFiles();
}

// ==========================
// 初始化：媒体预览
// ==========================
function initMediaPreview() {
  const preview = document.getElementById('mediaPreview');
  const img = document.getElementById('mediaPreviewImg');
  const video = document.getElementById('mediaPreviewVideo');
  const audioExts = ['mp3', 'wav', 'ogg', 'flac', 'm4a'];

  const audioManager = {
    audio: null,
    currentUrl: '',
    currentName: '',
    isPlaying: false,

    init() {
      if (!this.audio) {
        this.audio = new Audio();
        this.audio.preload = 'none';
        this.audio.crossOrigin = 'anonymous';
        this.audio.addEventListener('play', () => { this.isPlaying = true; });
        this.audio.addEventListener('pause', () => { this.isPlaying = false; });
        this.audio.addEventListener('ended', () => {
          this.isPlaying = false;
          showToast(`播放完成: ${this.currentName}`);
        });
        this.audio.addEventListener('error', (e) => {
          this.isPlaying = false;
          showToast('播放出错');
          console.error('Audio error:', e);
        });
        document.addEventListener('visibilitychange', () => {
          if (document.hidden && this.isPlaying) {
            setTimeout(() => {
              if (this.audio.paused && this.isPlaying) {
                this.audio.play().catch(() => { });
              }
            }, 100);
          }
        });
      }
    },

    play(url, name) {
      this.init();
      showToast(`正在播放: ${name}`);
      if (this.currentUrl === url) {
        if (this.audio.paused) {
          this.audio.play().catch(() => showToast('播放失败'));
        } else {
          this.audio.pause();
          showToast(`已暂停: ${name}`);
        }
        return;
      }
      this.currentUrl = url;
      this.currentName = name;
      this.audio.src = url;
      const playPromise = this.audio.play();
      if (playPromise !== undefined) {
        playPromise.catch((error) => {
          showToast(`需要用户交互才能播放: ${name}`);
          console.log('Autoplay prevented:', error);
        });
      }
    }
  };

  preview.onclick = function () {
    preview.classList.add('hidden');
    img.src = '';
    video.src = '';
    img.style.display = 'none';
    video.style.display = 'none';
    video.pause();
  };

  document.getElementById('fileList').addEventListener('click', function (e) {
    if (e.target.classList.contains('multi-select-checkbox')) return;
    if (e.target.closest('.flex.gap-1,button')) return;
    const item = e.target.closest('.file-item');
    if (!item) return;
    const name = item.querySelector('.file-name') ? item.querySelector('.file-name').textContent : '';
    const ext = name.split('.').pop()?.toLowerCase();
    const file = state.files.find(f => f.name === name);
    if (!file || file.type !== 'file') return;
    const url = file.download_url
      ? `https://gh-proxy.com/${file.download_url}`
      : `https://gh-proxy.com/${file.html_url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/')}`;

    if (audioExts.includes(ext)) {
      const nameWithoutExt = name.substring(0, name.lastIndexOf('.'));
      audioManager.play(url, nameWithoutExt);
      e.imagePreviewAction = true;
      e.preventDefault();
      e.stopPropagation();
      return;
    }

    if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'svg'].includes(ext)) {
      img.src = url;
      img.style.display = '';
      video.style.display = 'none';
      preview.classList.remove('hidden');
      e.imagePreviewAction = true;
      e.preventDefault();
      e.stopPropagation();
      return;
    }

    if (['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'].includes(ext)) {
      video.src = url;
      video.style.display = '';
      img.style.display = 'none';
      preview.classList.remove('hidden');
      e.imagePreviewAction = true;
      e.preventDefault();
      e.stopPropagation();
      video.load();
      return;
    }
  }, true);
}

// ==========================
// 弹窗：新建仓库
// ==========================
function showCreateRepoModal() {
  document.getElementById('createRepoNameInput').value = '';
  document.getElementById('createRepoDescInput').value = '';
  document.getElementById('createRepoPrivate').checked = true;
  document.getElementById('repoNameError').style.display = 'none';
  document.getElementById('createRepoModal').classList.remove('hidden');

  const nameInput = document.getElementById('createRepoNameInput');
  const descInput = document.getElementById('createRepoDescInput');
  const privateCheckbox = document.getElementById('createRepoPrivate');
  const confirmBtn = document.getElementById('createRepoConfirm');
  const cancelBtn = document.getElementById('createRepoCancel');
  const errorDiv = document.getElementById('repoNameError');

  function validateRepoName(name) {
    const chineseRegex = /[\u4e00-\u9fa5]/;
    if (chineseRegex.test(name)) return '仓库名称不能包含中文字符';
    const validNameRegex = /^[a-zA-Z0-9._-]+$/;
    if (!validNameRegex.test(name)) return '仓库名称只能包含英文字母、数字、点号、下划线和连字符';
    if (name.length < 1) return '仓库名称不能为空';
    if (name.length > 100) return '仓库名称不能超过100个字符';
    if (name.startsWith('.') || name.endsWith('.')) return '仓库名称不能以点号开头或结尾';
    return null;
  }

  nameInput.oninput = function () {
    const name = nameInput.value.trim();
    const error = validateRepoName(name);
    if (error) {
      errorDiv.textContent = error;
      errorDiv.style.display = 'block';
      confirmBtn.disabled = true;
    } else {
      errorDiv.style.display = 'none';
      confirmBtn.disabled = !name;
    }
  };

  cancelBtn.onclick = function () {
    document.getElementById('createRepoModal').classList.add('hidden');
  };

  confirmBtn.onclick = async function () {
    const name = nameInput.value.trim();
    const description = descInput.value.trim();
    const isPublic = privateCheckbox.checked; // 文案为“公开仓库”，选中时为公开
    const error = validateRepoName(name);
    if (error || !name) return;

    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '创建中 <i class="fa fa-spinner fa-spin"></i>';

    try {
      const res = await fetch('https://api.github.com/user/repos', {
        method: 'POST',
        headers: ghHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify({
          name,
          description: description || undefined,
          private: !isPublic,
          auto_init: true
        })
      });

      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.message || '创建仓库失败');
      }

      await res.json();
      showToast(`仓库 "${name}" 创建成功`);
      document.getElementById('createRepoModal').classList.add('hidden');
      fetchRepos();
    } catch (e) {
      showToast(`创建失败: ${e.message}`);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '创建仓库';
    }
  };
}

// ==========================
// 历史：拦截系统返回键
// ==========================
function setupHistoryInterception() {
  history.pushState(null, '', location.href);
  window.addEventListener('popstate', function () {
    goUp();
    history.pushState(null, '', location.href);
  });
}

// ==========================
// 事件：绑定 UI 交互
// ==========================
function setupEventListeners() {
  el.newFolderBtn.onclick = function () {
    if (!state.currentRepo) {
      showCreateRepoModal();
    } else {
      showCreateFolderModal();
    }
  };

  el.authBtn.addEventListener('click', () => {
    const token = el.tokenInput.value.trim();
    if (token) {
      localStorage.setItem('gh_token', token);
      state.token = token;
      showApp();
      fetchRepos();
    } else {
      showToast('请输入令牌');
    }
  });

  el.mainMenuBtn.onclick = (e) => {
    e.stopPropagation();
    hideContextMenu();
    updateNewFolderBtnLabel();
    el.mainMenuPopup.classList.toggle('hidden');
  };

  document.addEventListener('click', function (e) {
    if (!el.mainMenuPopup.classList.contains('hidden')) {
      if (!el.mainMenuPopup.contains(e.target) && e.target !== el.mainMenuBtn) {
        el.mainMenuPopup.classList.add('hidden');
      }
    }
  });

  el.menuRepoList.onclick = () => {
    el.mainMenuPopup.classList.add('hidden');
    showRepoListView();
  };

  el.menuRefresh.onclick = () => {
    el.mainMenuPopup.classList.add('hidden');
    if (!state.currentRepo) {
      fetchRepos();
    } else {
      fetchFiles(true);
    }
  };

  el.menuLogout.onclick = () => {
    el.mainMenuPopup.classList.add('hidden');
    localStorage.removeItem('gh_token');
    state.token = null;
    state.repos = [];
    state.currentRepo = null;
    showAuth();
  };

  el.saveEdit.addEventListener('click', saveEditedFile);

  document.addEventListener('click', hideContextMenu);
  document.addEventListener('touchstart', (e) => {
    if (!el.contextMenu.contains(e.target)) hideContextMenu();
  });
  document.addEventListener('touchmove', (e) => {
    if (!el.contextMenu.contains(e.target)) hideContextMenu();
  });

  el.modalOverlay.addEventListener('click', (e) => {
    if (e.target === el.modalOverlay) hideModal();
  });

  el.backBtn.onclick = goUp;

  el.newFileBtn.onclick = showCreateFileModal;

  el.uploadBtn.onclick = handleUploadClick;
  el.fileUploadInput.addEventListener('change', handleFilesSelected);
}

// ==========================
// 初始化：主入口
// ==========================
function init() {
  if (state.token) {
    showApp();
    updateNewFolderBtnLabel();
    loadReposFromCache();
  } else {
    showAuth();
  }
  setupEventListeners();
  setupHistoryInterception();
  initMediaPreview();
}

document.addEventListener('DOMContentLoaded', init);

// ==========================
// 手势缩放字体大小（编辑器）
// ==========================
(function () {
  const config = {
    minFontSize: 3,
    maxFontSize: 40,
    defaultFontSize: 12,
    storageKey: 'editor-font-size',
    scaleSensitivity: 0.01
  };

  function getSavedFontSize() {
    const saved = localStorage.getItem(config.storageKey);
    return saved ? parseInt(saved) : config.defaultFontSize;
  }

  function saveFontSize(size) {
    localStorage.setItem(config.storageKey, size);
  }

  function createFontSizeDisplay() {
    const display = document.createElement('div');
    display.style.cssText = `
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
    `;
    return display;
  }

  function showFontSizeTooltip(display, size) {
    display.textContent = `${size}px`;
    display.style.opacity = '1';
    clearTimeout(display.hideTimeout);
    display.hideTimeout = setTimeout(() => {
      display.style.opacity = '0';
    }, 1000);
  }

  function initGestureControls() {
    const observer = new MutationObserver(() => {
      const editModal = document.getElementById('editModal');
      const fileContent = document.getElementById('fileContent');
      const editorContainer = document.querySelector('.editor-container');

      if (editModal && fileContent && editorContainer && !fileContent.hasGestureControl) {
        fileContent.hasGestureControl = true;

        let currentSize = getSavedFontSize();
        fileContent.style.fontSize = currentSize + 'px';
        fileContent.style.lineHeight = (currentSize * 1.5) + 'px';

        const fontSizeDisplay = createFontSizeDisplay();
        editorContainer.appendChild(fontSizeDisplay);

        let initialDistance = 0;
        let initialFontSize = currentSize;
        let isPinching = false;

        function getTouchDistance(touches) {
          const dx = touches[0].clientX - touches[1].clientX;
          const dy = touches[0].clientY - touches[1].clientY;
          return Math.sqrt(dx * dx + dy * dy);
        }

        function updateFontSize(size) {
          size = Math.max(config.minFontSize, Math.min(config.maxFontSize, Math.round(size)));
          currentSize = size;
          fileContent.style.fontSize = size + 'px';
          fileContent.style.lineHeight = (size * 1.5) + 'px';
          showFontSizeTooltip(fontSizeDisplay, size);
          saveFontSize(size);
        }

        fileContent.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            e.preventDefault();
            isPinching = true;
            initialDistance = getTouchDistance(e.touches);
            initialFontSize = currentSize;
          }
        }, { passive: false });

        fileContent.addEventListener('touchmove', (e) => {
          if (isPinching && e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = getTouchDistance(e.touches);
            const scale = currentDistance / initialDistance;
            const newSize = initialFontSize * scale;
            updateFontSize(newSize);
          }
        }, { passive: false });

        fileContent.addEventListener('touchend', () => {
          if (isPinching) isPinching = false;
        });

        fileContent.addEventListener('wheel', (e) => {
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -1 : 1;
            const newSize = currentSize + delta;
            updateFontSize(newSize);
          }
        }, { passive: false });

        fileContent.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
            e.preventDefault();
            updateFontSize(currentSize + 1);
          } else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
            e.preventDefault();
            updateFontSize(currentSize - 1);
          } else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
            e.preventDefault();
            updateFontSize(config.defaultFontSize);
          }
        });

        const editModalObserver = new MutationObserver(() => {
          if (!editModal.classList.contains('hidden')) {
            currentSize = getSavedFontSize();
            fileContent.style.fontSize = currentSize + 'px';
            fileContent.style.lineHeight = (currentSize * 1.5) + 'px';
          }
        });
        editModalObserver.observe(editModal, { attributes: true, attributeFilter: ['class'] });

        const helpText = document.createElement('div');
        helpText.style.cssText = `
          position: absolute;
          bottom: 10px;
          right: 30px;
          color: white;
          font-size: 12px;
          opacity: 0.6;
          z-index: 100;
        `;
        helpText.innerHTML = '双指缩放调整字体 | Ctrl+滚轮缩放';
        editorContainer.appendChild(helpText);
        setTimeout(() => {
          helpText.style.transition = 'opacity 0.6s';
          helpText.style.opacity = '0';
          setTimeout(() => helpText.remove(), 500);
        }, 8000);
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGestureControls);
  } else {
    initGestureControls();
  }
})();

// ==========================
// 编辑器：最大化/恢复
// ==========================
(function () {
  'use strict';

  const config = {
    buttonId: 'toggleMaximizeModal',
    modalId: 'editModal',
    closeButtonId: 'closeEditModal',
    maximizedClass: 'maximized',
    expandIcon: 'fa-expand',
    compressIcon: 'fa-compress',
    buttonTitle: { maximize: '最大化', restore: '恢复' }
  };

  let isMaximized = false;
  let maximizeButton = null;
  let editModal = null;
  let isToggling = false;
  let modalObserver = null;

  function createMaximizeButton() {
    const button = document.createElement('button');
    button.id = config.buttonId;
    button.title = config.buttonTitle.maximize;
    button.innerHTML = `<i class="fa ${config.expandIcon}"></i>`;
    return button;
  }

  function addStyles() {
    if (document.getElementById('editor-maximize-styles')) return;
    const style = document.createElement('style');
    style.id = 'editor-maximize-styles';
    style.textContent = `
      #${config.buttonId} {
        padding: 0.5rem;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 9999px;
        transition: background-color 0.2s;
      }
      #${config.modalId}.${config.maximizedClass} { padding: 0 !important; }
      #${config.modalId}.${config.maximizedClass} .modal-content {
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        min-height: 100vh !important;
        border-radius: 0 !important;
        margin: 0 !important;
        display: flex;
        flex-direction: column;
      }
      #${config.modalId}.${config.maximizedClass} .editor-container {
        height: calc(100vh - 120px) !important;
        flex: 1;
        overflow: hidden;
      }
      #${config.modalId}.${config.maximizedClass} #fileContent {
        height: 100% !important;
        min-height: unset !important;
      }
      #${config.modalId}.${config.maximizedClass} .modal-header { flex-shrink: 0; }
      #${config.modalId}.${config.maximizedClass} .modal-footer { flex-shrink: 0; }
    `;
    document.head.appendChild(style);
  }

  function toggleMaximize() {
    if (!editModal || !maximizeButton || isToggling) return;
    isToggling = true;

    const icon = maximizeButton.querySelector('i');

    if (isMaximized) {
      editModal.classList.remove(config.maximizedClass);
      icon.classList.remove(config.compressIcon);
      icon.classList.add(config.expandIcon);
      maximizeButton.title = config.buttonTitle.maximize;
      isMaximized = false;
      try {
        if (typeof window.adjustEditorDimensions === 'function') {
          setTimeout(window.adjustEditorDimensions, 100);
        }
      } catch (e) {
        console.error('调整编辑器尺寸时出错:', e);
      }
    } else {
      editModal.classList.add(config.maximizedClass);
      icon.classList.remove(config.expandIcon);
      icon.classList.add(config.compressIcon);
      maximizeButton.title = config.buttonTitle.restore;
      isMaximized = true;
    }
    try {
      localStorage.setItem('editor-maximized', isMaximized.toString());
    } catch (e) {
      console.error('保存最大化状态时出错:', e);
    }

    setTimeout(() => { isToggling = false; }, 300);
  }

  function restoreMaximizedState() {
    if (isToggling) return;
    try {
      const savedState = localStorage.getItem('editor-maximized') === 'true';
      if (savedState && editModal && !editModal.classList.contains('hidden')) {
        isMaximized = false;
        toggleMaximize();
      }
    } catch (e) {
      console.error('恢复最大化状态时出错:', e);
    }
  }

  function resetMaximizedState() {
    if (isToggling) return;
    if (isMaximized) {
      isMaximized = true;
      toggleMaximize();
    }
  }

  function initializeButton() {
    if (maximizeButton) return;
    if (!editModal) {
      editModal = document.getElementById(config.modalId);
      if (!editModal) return;
    }

    const modalHeader = editModal.querySelector('.modal-header');
    const closeButton = document.getElementById(config.closeButtonId);
    if (!modalHeader || !closeButton) return;

    let buttonContainer = modalHeader.querySelector('div:last-child');
    if (!buttonContainer || !buttonContainer.style.display || buttonContainer.style.display !== 'flex') {
      buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = 'display: flex; gap: 0.5rem;';
      if (closeButton.parentNode === modalHeader) modalHeader.removeChild(closeButton);
      buttonContainer.appendChild(closeButton);
      modalHeader.appendChild(buttonContainer);
    }

    if (document.getElementById(config.buttonId)) {
      maximizeButton = document.getElementById(config.buttonId);
    } else {
      maximizeButton = createMaximizeButton();
      buttonContainer.insertBefore(maximizeButton, closeButton);
    }

    maximizeButton.removeEventListener('click', toggleMaximize);
    maximizeButton.addEventListener('click', toggleMaximize);

    if (!modalObserver) {
      modalObserver = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          if (mutation.attributeName === 'class') {
            if (editModal.classList.contains('hidden')) {
              resetMaximizedState();
            } else {
              setTimeout(restoreMaximizedState, 100);
            }
          }
        }
      });
      modalObserver.observe(editModal, { attributes: true, attributeFilter: ['class'] });
    }
  }

  function init() {
    addStyles();
    const observer = new MutationObserver(() => {
      if (!maximizeButton || !document.getElementById(config.buttonId)) {
        initializeButton();
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
    initializeButton();

    document.addEventListener('keydown', (e) => {
      if (editModal && !editModal.classList.contains('hidden')) {
        if (e.key === 'F11' || (e.ctrlKey && e.shiftKey && e.key === 'M')) {
          e.preventDefault();
          toggleMaximize();
        }
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();


    </script>
</body>
</html>