<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 仓库管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 60px;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 12px;
            transition: transform 0.2s;
            height: 80px;
        }
        .card:active {
            transform: scale(0.98);
        }
        .file-icon {
            font-size: 1rem;
            margin-right: 8px;
            color: #6c757d;
        }
        .folder-icon {
            color: #ffc107;
        }
        .file-size {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .action-btn {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 12px 0;
            margin-bottom: 16px;
            border-radius: 0 0 8px 8px;
        }
        .loading {
            display: flex;
            justify-content: center;
            padding: 16px;
        }
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-form {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="auth-modal d-none" id="authModal">
        <div class="auth-form">
            <h4 class="text-center mb-4">GitHub 仓库认证</h4>
            <div class="form-group">
                <label for="apiToken" class="form-label">API Token</label>
                <input type="password" id="apiToken" class="form-control" placeholder="请输入GitHub API Token" required>
                <small class="form-text text-muted">在GitHub个人设置中生成Token，需包含repo权限</small>
            </div>
            <div class="form-group">
                <label for="repoOwner" class="form-label">仓库所有者</label>
                <input type="text" id="repoOwner" class="form-control" value="rjdsq" required>
            </div>
            <div class="form-group">
                <label for="repoName" class="form-label">仓库名称</label>
                <input type="text" id="repoName" class="form-control" placeholder="输入仓库名" value="ksx" required>
            </div>
            <button id="authSubmit" class="btn btn-primary w-100">确认登录</button>
        </div>
    </div>

    <div class="header text-center">
        <h4 class="mb-0">GitHub 仓库管理</h4>
        <small class="opacity-75" id="repoInfo">--/--</small>
    </div>
    <div class="container">
        <div class="d-flex align-items-center mb-3">
            <div id="back-btn-container" class="d-none">
                <button id="back-btn" class="btn btn-sm btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left"></i> 返回上一级
                </button>
            </div>
            <div id="breadcrumb" class="flex-grow-1"></div>
        </div>
        
        <div class="d-flex gap-2 mb-3">
            <button id="create-folder-btn" class="btn btn-success flex-grow-1">
                <i class="bi bi-folder-plus"></i> 新建文件夹
            </button>
            <button id="upload-btn" class="btn btn-primary flex-grow-1">
                <i class="bi bi-upload"></i> 上传文件
            </button>
        </div>
        
        <input type="file" id="file-input" style="display: none;">
        
        <div id="content-container">
            <div class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>
    </div>
    <!-- 长按菜单 -->
    <div id="context-menu" class="position-fixed bg-white shadow rounded p-2" style="display: none; z-index: 1000;">
        <button class="btn btn-sm btn-outline-danger w-100 mb-1" id="menu-delete-btn">
            <i class="bi bi-trash"></i> 删除
        </button>
        <button class="btn btn-sm btn-outline-primary w-100" id="menu-copy-btn">
            <i class="bi bi-link-45deg"></i> 复制链接
        </button>
    </div>
    <script>
// 移除本地存储，每次打开都需要重新输入认证信息
let API_TOKEN = '';
let REPO_OWNER = 'rjdsq'; // 默认仓库所有者
let REPO_NAME = '';
let currentMenuTarget = null;
let currentPath = '';
let historyStack = [];

// 检查认证状态，未认证则显示登录模态框
document.getElementById('authModal').classList.remove('d-none');
document.getElementById('repoOwner').value = REPO_OWNER;
document.getElementById('repoName').focus();

document.getElementById('authSubmit').addEventListener('click', saveAuthInfo);

function saveAuthInfo() {
    const token = document.getElementById('apiToken').value.trim();
    const owner = document.getElementById('repoOwner').value.trim();
    const name = document.getElementById('repoName').value.trim();
    
    if (!token || !owner || !name) {
        alert('请填写完整的认证信息');
        return;
    }
    
    API_TOKEN = token;
    REPO_OWNER = owner;
    REPO_NAME = name;
    
    document.getElementById('authModal').classList.add('d-none');
    document.getElementById('repoInfo').textContent = `${REPO_OWNER}/${REPO_NAME}`;
    initApp();
}

function initApp() {
    initGestures();
    loadRepoContents();
}

// 初始化菜单和事件
function initGestures() {
    // 返回按钮事件
    document.getElementById('back-btn').addEventListener('click', () => {
        if (historyStack.length > 1) {
            historyStack.pop();
            const prevPath = historyStack[historyStack.length - 1];
            loadRepoContents(prevPath);
        } else if (historyStack.length === 1) {
            historyStack.pop();
            loadRepoContents('');
        }
    });
    // 右键菜单事件
    document.addEventListener('contextmenu', (e) => {
        const card = e.target.closest('.card');
        if (card) {
            e.preventDefault();
            currentMenuTarget = card;
            showContextMenu(card, e.clientX, e.clientY);
        }
    });
    // 菜单按钮事件
    document.getElementById('menu-delete-btn').addEventListener('click', () => {
        if (currentMenuTarget) {
            const deleteBtn = currentMenuTarget.querySelector('.delete-btn');
            if (deleteBtn) deleteBtn.click();
            hideContextMenu();
        }
    });
    document.getElementById('menu-copy-btn').addEventListener('click', () => {
        if (currentMenuTarget) {
            const copyBtn = currentMenuTarget.querySelector('.copy-raw-btn');
            if (copyBtn) copyBtn.click();
            hideContextMenu();
        }
    });
    // 点击其他地方隐藏菜单
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#context-menu')) {
            hideContextMenu();
        }
    });
}

// 显示上下文菜单
function showContextMenu(card, x, y) {
    const menu = document.getElementById('context-menu');
    currentMenuTarget = card;
    
    const isFolder = card.dataset.type === 'folder';
    const viewBtn = document.getElementById('menu-view-btn');
    viewBtn.style.display = isFolder ? 'block' : 'none';
    
    menu.style.display = 'block';
    menu.style.left = `${Math.min(x, window.innerWidth - 150)}px`;
    menu.style.top = `${Math.min(y, window.innerHeight - 100)}px`;
}

// 隐藏上下文菜单
function hideContextMenu() {
    const menu = document.getElementById('context-menu');
    menu.style.display = 'none';
    currentMenuTarget = null;
}

// 创建文件夹
async function createFolder(folderName) {
    const path = currentPath ? `${currentPath}/${folderName}` : folderName;
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}/.gitkeep`;
    
    try {
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${API_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `创建文件夹 ${folderName}`,
                content: btoa("")
            })
        });
        if (!response.ok) {
            throw new Error(`创建文件夹失败: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        console.error('创建文件夹错误:', error);
        throw error;
    }
}

// 显示创建文件夹对话框
function showCreateFolderDialog() {
    const folderName = prompt('请输入文件夹名称:');
    if (folderName) {
        createFolder(folderName)
            .then(() => loadRepoContents(currentPath))
            .catch(err => alert(`创建失败: ${err.message}`));
    }
}

// 加载仓库内容
async function loadRepoContents(path = '') {
    const container = document.getElementById('content-container');
    container.innerHTML = `
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    `;
    
    currentPath = path;
    updateBreadcrumb();
    
    try {
        const contents = await fetchRepoContents(path);
        renderContents(contents);
    } catch (error) {
        console.error('加载内容失败:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                加载内容失败: ${error.message || '未知错误'}
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="loadRepoContents('${path}')">
                    <i class="bi bi-arrow-clockwise"></i> 重试
                </button>
            </div>
        `;
    }
}

// 获取仓库内容
async function fetchRepoContents(path) {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;
    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': `token ${API_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                throw new Error('认证失败，请检查Token是否有效');
            } else if (response.status === 404) {
                throw new Error(`仓库或路径不存在: ${REPO_OWNER}/${REPO_NAME}`);
            } else if (response.status === 403) {
                throw new Error('权限不足，Token需包含repo权限');
            } else {
                throw new Error(`GitHub API 错误: ${response.status} ${response.statusText}`);
            }
        }
        
        return await response.json();
    } catch (error) {
        if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
            throw new Error('网络错误，无法连接到GitHub API');
        }
        throw error;
    }
}

// 渲染内容列表
function renderContents(contents) {
    const container = document.getElementById('content-container');
    
    if (!contents || contents.length === 0) {
        container.innerHTML = '<div class="alert alert-info">此目录为空</div>';
        return;
    }
    
    let html = '';

    // 先显示文件夹
    contents.filter(item => item.type === 'dir').forEach(item => {
        html += createFolderCard(item);
    });
    
    // 再显示文件
    contents.filter(item => item.type === 'file').forEach(item => {
        html += createFileCard(item);
    });
    
    container.innerHTML = html;
    
    // 添加事件监听
    document.querySelectorAll('.folder-card').forEach(card => {
        card.addEventListener('click', (e) => {
            if (!e.target.closest('.action-btn')) {
                loadRepoContents(card.dataset.path);
            }
        });
    });
    
    // 添加删除按钮事件
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const card = btn.closest('.card');
            const path = card.dataset.path;
            
            const isFolder = card.classList.contains('folder-card');
            const confirmMsg = isFolder 
                ? `确定要删除文件夹 ${path} 及其所有内容吗？此操作不可撤销！` 
                : `确定要删除 ${path} 吗？此操作不可撤销！`;
            
            if (confirm(confirmMsg)) {
                try {
                    await deleteFile(path, isFolder);
                    card.style.opacity = '0.5';
                    setTimeout(() => {
                        loadRepoContents(currentPath);
                    }, 300);
                } catch (error) {
                    alert('删除失败: ' + error.message);
                }
            }
        });
    });
    
    // 添加复制链接按钮事件
    document.querySelectorAll('.copy-raw-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            navigator.clipboard.writeText(btn.dataset.url)
                .then(() => {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check"></i> 已复制';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                })
                .catch(err => {
                    alert('复制失败: ' + err);
                });
        });
    });
    
    // 添加右键菜单支持
    document.querySelectorAll('.card').forEach(card => {
        card.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            currentMenuTarget = card;
            showContextMenu(card, e.clientX, e.clientY);
        });
    });
}

// 创建文件夹卡片
function createFolderCard(item) {
    return `
        <div class="card folder-card" data-path="${item.path}" data-type="folder">
            <div class="card-body d-flex align-items-center">
                <i class="bi bi-folder-fill folder-icon"></i>
                <div class="flex-grow-1">
                    <h6 class="mb-0">${item.name}</h6>
                </div>
                <button class="btn btn-sm btn-outline-secondary action-btn">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
            </div>
        </div>
    `;
}

// 创建文件卡片
function createFileCard(item) {
    const sizeKB = (item.size / 1024).toFixed(2);
    
    return `
        <div class="card file-card" data-path="${item.path}" data-type="file">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-file-earmark file-icon"></i>
                    <h6 class="mb-0 flex-grow-1">${item.name}</h6>
                    <span class="file-size">${sizeKB} KB</span>
                </div>
                <div class="d-flex justify-content-between gap-1">
                    <button class="btn btn-sm btn-outline-primary action-btn copy-raw-btn flex-grow-1" data-url="${item.download_url}">
                        <i class="bi bi-link-45deg"></i> 复制链接
                    </button>
                    <button class="btn btn-sm btn-outline-danger action-btn delete-btn">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            </div>
        </div>
    `;
}

// 添加上传功能
document.getElementById('upload-btn').addEventListener('click', () => {
    document.getElementById('file-input').click();
});

document.getElementById('file-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const uploadBtn = document.getElementById('upload-btn');
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 上传中...';
    uploadBtn.disabled = true;
    
    try {
        await uploadFile(file);
        loadRepoContents(currentPath);
    } catch (error) {
        alert('上传失败: ' + error.message);
    } finally {
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        e.target.value = '';
    }
});

// 上传文件到GitHub
async function uploadFile(file) {
    const path = currentPath ? `${currentPath}/${file.name}` : file.name;
    const content = await readFileAsBase64(file);
    
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;
    
    const response = await fetch(url, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${API_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: `上传文件 ${file.name}`,
            content: content
        })
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || '上传失败');
    }
    
    return await response.json();
}

// 读取文件为Base64
function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const base64String = reader.result.split(',')[1];
            resolve(base64String);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// 删除文件或文件夹
async function deleteFile(path, isFolder = false) {
    if (isFolder) {
        return await deleteFolder(path);
    }
    
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;
    
    try {
        // 获取文件的SHA
        const response = await fetch(url, {
            headers: {
                'Authorization': `token ${API_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`获取文件信息失败: ${response.statusText}`);
        }
        
        const fileInfo = await response.json();
        if (!fileInfo.sha) {
            throw new Error('无法获取文件SHA');
        }
        
        const deleteResponse = await fetch(url, {
            method: 'DELETE',
            headers: {
                'Authorization': `token ${API_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `删除文件 ${path}`,
                sha: fileInfo.sha
            })
        });
        
        if (!deleteResponse.ok) {
            const errorData = await deleteResponse.json();
            throw new Error(errorData.message || '删除失败');
        }
        
        return await deleteResponse.json();
    } catch (error) {
        console.error('删除文件错误:', error);
        throw new Error(`删除文件失败: ${error.message}`);
    }
}

// 递归删除文件夹
async function deleteFolder(path) {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;
    
    try {
        // 获取文件夹内容
        const contents = await fetch(url, {
            headers: {
                'Authorization': `token ${API_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        }).then(res => res.json());
        
        // 递归删除所有内容
        for (const item of contents) {
            if (item.type === 'file') {
                await deleteFile(item.path, false);
            } else if (item.type === 'dir') {
                await deleteFolder(item.path);
            }
        }
        
        // 删除.gitkeep文件
        try {
            await deleteFile(`${path}/.gitkeep`, false);
        } catch {}
        
        return true;
    } catch (error) {
        console.error('删除文件夹错误:', error);
        throw error;
    }
}

// 更新面包屑导航
function updateBreadcrumb() {
    const breadcrumb = document.getElementById('breadcrumb');
    const backBtnContainer = document.getElementById('back-btn-container');
    const parts = currentPath.split('/').filter(p => p);
    
    let html = '<nav aria-label="breadcrumb"><ol class="breadcrumb">';
    html += '<li class="breadcrumb-item"><a href="#" data-path="">根目录</a></li>';
    
    let accumulatedPath = '';
    parts.forEach((part, index) => {
        accumulatedPath += (accumulatedPath ? '/' : '') + part;
        const isLast = index === parts.length - 1;
        
        html += `<li class="breadcrumb-item ${isLast ? 'active' : ''}">`;
        if (!isLast) {
            html += `<a href="#" data-path="${accumulatedPath}">${part}</a>`;
        } else {
            html += part;
        }
        html += '</li>';
    });
    
    html += '</ol></nav>';
    breadcrumb.innerHTML = html;
    
    // 更新历史记录和返回按钮
    if (historyStack[historyStack.length - 1] !== currentPath) {
        if (currentPath) {
            historyStack.push(currentPath);
        }
    }
    backBtnContainer.style.display = historyStack.length > 0 ? 'flex' : 'none';
    
    // 添加面包屑点击事件
    document.querySelectorAll('#breadcrumb a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const newPath = link.dataset.path;
            if (newPath !== currentPath) {
                historyStack.push(currentPath);
            }
            loadRepoContents(newPath);
        });
    });
}

// 手动选择目录功能（添加到导航栏）
function addDirectorySelector() {
    const backBtnContainer = document.getElementById('back-btn-container');
    const selector = document.createElement('div');
    selector.className = 'd-flex align-items-center ms-2';
    
    selector.innerHTML = `
        <button id="select-directory-btn" class="btn btn-sm btn-outline-info me-2">
            <i class="bi bi-folder2-open"></i> 选择目录
        </button>
    `;
    
    backBtnContainer.appendChild(selector);
    
    document.getElementById('select-directory-btn').addEventListener('click', showDirectorySelector);
}

// 显示目录选择模态框
function showDirectorySelector() {
    const modal = document.createElement('div');
    modal.className = 'auth-modal d-block fixed inset-0 bg-black/50 z-50 flex items-center justify-center';
    modal.id = 'directorySelectorModal';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'auth-form';
    modalContent.innerHTML = `
        <h4 class="text-center mb-4">选择目录</h4>
        <div class="form-group">
            <label for="directory-path" class="form-label">输入目录路径 (例如: docs/images)</label>
            <input type="text" id="directory-path" class="form-control" placeholder="输入目录路径">
        </div>
        <div class="d-flex justify-content-center gap-2">
            <button id="cancel-directory" class="btn btn-sm btn-outline-secondary">取消</button>
            <button id="confirm-directory" class="btn btn-sm btn-primary">确认</button>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    document.getElementById('cancel-directory').addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    document.getElementById('confirm-directory').addEventListener('click', () => {
        const path = document.getElementById('directory-path').value.trim();
        if (path) {
            loadRepoContents(path);
            document.body.removeChild(modal);
        } else {
            alert('请输入有效的目录路径');
        }
    });
}


    </script>
</body>
</html>